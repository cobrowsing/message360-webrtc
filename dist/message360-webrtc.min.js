var app=angular.module("vertoApp",["ngStorage","ui.bootstrap","ngAnimate","ui.router","vertoControllers","pascalprecht.translate","timer","cgPrompt","ngToast","ngAudio","ngCookies","angularMoment"]);app.config(["$stateProvider","$urlRouterProvider","$translateProvider",function($stateProvider,$urlRouterProvider,$translateProvider){$stateProvider.state("loading",{url:"/",templateUrl:"src/views/partials/load_screen.html",controller:"loadScreenController",title:"Loading..."}).state("login",{url:"/login",templateUrl:"src/views/partials/login.html",controller:"loginController",title:"Welcome!"}).state("dashboard",{url:"/dashboard",templateUrl:"src/views/partials/dashboard.html",title:"Dashboard"}),$urlRouterProvider.otherwise("/"),$translateProvider.preferredLanguage("en").determinePreferredLanguage().fallbackLanguage("en").useSanitizeValueStrategy(null)}]),app.config(["ngToastProvider",function(ngToastProvider){ngToastProvider.configure({additionalClasses:"animated zoomInRight"})}]),app.filter("phoneFilter",function(){return function(tel){if(!tel)return"";var value=tel.toString().trim().replace(/^\+/,"");if(value.match(/[^0-9]/))return tel;var country,city,number;switch(value.length){case 10:country=1,city=value.slice(0,3),number=value.slice(3);break;case 11:country=value[0],city=value.slice(1,4),number=value.slice(4);break;case 12:country=value.slice(0,3),city=value.slice(3,5),number=value.slice(5);break;default:return tel}return number=number.slice(0,3)+"-"+number.slice(3),(country+" ("+city+") "+number).trim()}}),app.run(["$rootScope","$location",function($rootScope,$location){window.onbeforeunload=function(e){window.location.ref="/"}}]);var vertoControllers=angular.module("vertoControllers",["ui.bootstrap","vertoService","storageService"]),mainController=angular.module("vertoControllers").controller("mainController",["$scope","$rootScope","$http","$location","$timeout","$q","verto","storage","$state","prompt","ngToast","callHistory","ngAudio","$uibModal","moment",function($scope,$rootScope,$http,$location,$timeout,$q,verto,storage,$state,prompt,ngToast,callHistory,ngAudio,$uibModal,moment){function checkFunds(){$http.post(fundUrl).then(function(response){1!=response.data.Message360.ResponseStatus&&($scope.logout(),ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-info-circle'></i>"+response.data.Message360.Errors.Error[0].Message+"</p>"}))})}function onWSClose(event,data){if(!wsInstance){var options={backdrop:"static",keyboard:!1};$scope.showReconnect&&(wsInstance=$scope.openModal("src/views/partials/websocket_error.html","wsReconnectController",options)),verto.data.call&&verto.hangup()}}function onWSLogin(event,data){wsInstance&&(wsInstance.close(),wsInstance=null)}storage.data.language&&"browse"!==storage.data.language&&(storage.data.language="browser"),$scope.verto=verto,$scope.storage=storage,$scope.showReconnect=!0,$rootScope.dialpad={},$scope.callHistory=[];var tokenUrl="scripts/access-token.php",fundUrl="scripts/check-funds.php";$scope.timerRunning=!1,$scope.startTimer=function(){$scope.$broadcast("timer-start"),$scope.timerRunning=!0},$scope.stopTimer=function(){$scope.$broadcast("timer-stop"),$scope.timerRunning=!1},$scope.login=function(){var connectCallback=function(v,connected){$scope.$apply(function(){verto.data.connecting=!1,connected&&(storage.data.ui_connected=verto.data.connected,storage.data.ws_connected=verto.data.connected,storage.data.name=verto.data.name,storage.data.email=verto.data.email,storage.data.login=verto.data.login,storage.data.accessToken=verto.data.passwd,storage.data.numOfCalls=0,callHistory.clear()),1==verto.data.connected?$state.go("dashboard"):ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> There was an error connecting to the server.</p>"})})};$http.post(tokenUrl).then(function(response){if(response.data.Message360.Errors)return ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-info-circle'></i>"+response.data.Message360.Errors.Error[0].Message+"</p>"}),!1;if(response.data.Message360.Message.token){var token=response.data.Message360.Message.token;verto.data.login=token,verto.data.passwd=token}verto.data.connecting=!0,verto.connect(connectCallback)},function(err){err&&ngToast.create({className:"warning",content:"<p class='toast-text'><i class='fa fa-info-circle'></i> The Message360 SDK for authentication is not set up properly.</p>"})})},$rootScope.logout=function(){var disconnectCallback=function(){storage.factoryReset(),$state.go("login")};verto.data.call&&verto.hangup(),$scope.showReconnect=!1,verto.disconnect(disconnectCallback),verto.hangup(),ngToast.create("<p class='toast-text'><i class='ion-android-notifications'></i> Successfully logged out!</p>")},$rootScope.openModal=function(templateUrl,controller,_opts){var opts={animation:!0,templateUrl:templateUrl,controller:"wsReconnectController",size:"sm"};angular.extend(opts,_opts);var modalInstance=$uibModal.open(opts);modalInstance.result.then(function(result){},function(){})};var settingsInstance;$rootScope.openSettings=function(type){var options={animation:!0,controller:"sidemenuController",size:"sm"};"video"==type&&(options.templateUrl="src/views/modals/videoSettingsModal.html"),"audio"==type&&(options.templateUrl="src/views/modals/audioSettingsModal.html"),"speaker"==type&&(options.templateUrl="src/views/modals/speakerSettingsModal.html"),settingsInstance=$uibModal.open(options)},$rootScope.openSettingsModal=function(){verto.data.audioDevices.length&&verto.data.speakerDevices.length&&verto.data.audioDevices.length||verto.refreshDevices();var options={animation:!0,controller:"sidemenuController",size:"md",templateUrl:"src/views/modals/settingsModal.html"};settingsInstance=$uibModal.open(options)},$rootScope.closeSettings=function(){null!=settingsInstance&&(settingsInstance.close(),settingsInstance=null)},$rootScope.backspace=function(){var number=$rootScope.dialpad.number,length=number.length;$rootScope.dialpad.number=number.substring(0,length-1)},$rootScope.dtmf=function(number){"*"==number?ngAudio.play("src/sounds/dtmf/dtmf-star.mp3"):"#"==number?ngAudio.play("src/sounds/dtmf/dtmf-hash.mp3"):ngAudio.play("src/sounds/dtmf/dtmf-"+number+".mp3"),void 0!==$rootScope.dialpad.number&&null!==$rootScope.dialpad.number?$rootScope.dialpad.number=""+$rootScope.dialpad.number+number:$rootScope.dialpad.number=""+number},$rootScope.callActive=function(data,params){verto.data.mutedMic=storage.data.mutedMic,storage.data.cur_call||(storage.data.call_start=new Date),storage.data.userStatus="connected";var call_start=new Date(storage.data.call_start);$rootScope.start_time=call_start,$timeout(function(){$scope.startTimer(),$scope.incall=!0}),storage.data.calling=!1,storage.data.cur_call=1},$rootScope.$on("call.hangup",function(event,data){$timeout(function(){$scope.stopTimer()}),checkFunds(),$scope.incall=!1,storage.data.numOfCalls+=1,callHistory.addCall(storage.data.called_number,"Outbound",!0,$rootScope.start_time),$rootScope.start_time="",$scope.callHistory=storage.data.call_history,$rootScope.dialpad.number="";try{$rootScope.$digest()}catch(e){}}),$rootScope.$on("call.active",function(event,data,params){$rootScope.callActive(data,params)}),$rootScope.$on("call.calling",function(event,data){storage.data.calling=!0}),$rootScope.$on("call.incoming",function(event,data){storage.data.cur_call=0,$scope.incomingCall=!0,storage.data.videoCall=!1,storage.data.mutedMic=!1,storage.data.mutedVideo=!1,prompt({title:"Incoming call from "+data}).then(function(){var call_start=new Date(storage,data.call_start);$rootScope.start_time=call_start,$scope.answerCall(),storage.data.called_number=data,$state.go("incall")},function(){$scope.declineCall()})}),$scope.hold=function(){storage.data.onHold=!storage.data.onHold,verto.data.call.toggleHold()},$scope.cbMuteMic=function(event,data){storage.data.mutedMic=!storage.data.mutedMic},$scope.muteMic=verto.muteMic,$scope.hangup=function(){$timeout(function(){verto.data.call&&verto.hangup()},1e3)};var modalInstance;$scope.openChModal=function(){var options={animation:!0,controller:"chModalController",size:"md",templateUrl:"src/views/modals/callHistoryModal.html"};modalInstance=$uibModal.open(options)},$rootScope.$on("ws.close",onWSClose),$rootScope.$on("ws.login",onWSLogin);var wsInstance;$scope.answerCall=function(){storage.data.onHold=!1,verto.data.call.answer({useStereo:storage.data.useStereo,useCamera:storage.data.selectedVideo,useVideo:storage.data.useVideo,useMic:storage.data.useMic,callee_id_name:verto.data.name,callee_id_number:verto.data.login})}}]);mainController.$inject=["$scope","$rootScope","$http","$location","$timeout","$q","verto","storage","$state","prompt","ngToast","callHistory","ngAudio","$uibModal","moment"];var loginController=angular.module("vertoControllers").controller("loginController",["preRoute",function(preRoute){preRoute.checkLogin()}]);loginController.$inject=["preRoute"];var loadScreenController=angular.module("vertoControllers").controller("loadScreenController",["$scope","$location","$rootScope","$state","$timeout","storage","loadScreen","preRoute",function($scope,$location,$rootScope,$state,$timeout,storage,loadScreen,preRoute){preRoute.checkLogin(),$scope.progressPercentage=loadScreen.progressPercentage,$scope.message="",$scope.interruptNext=!1,$scope.errors=[];var redirectTo=function(link,activity){activity&&"initialize"==activity&&(link=activity),$location.path(link)},checkProgressState=function(currentProgress,status,promise,activity,soft,interruptNext,message){if($scope.progressPercentage=loadScreen.calculate(currentProgress),$scope.message=message,interruptNext&&"error"==status){if($scope.errors.push(message),!soft)return void redirectTo("",activity);message+=". Continue?",confirm(message)||($scope.interruptNext=!0)}if(!$scope.interruptNext)return $scope.message=loadScreen.getProgressMessage(currentProgress+1),!0};$rootScope.$on("progress.next",function(ev,currentProgress,status,promise,activity,soft,interrupt,message){$timeout(function(){return promise?void promise.then(function(response){message=response.message,status=response.status,checkProgressState(currentProgress,status,promise,activity,soft,interrupt,message)&&loadScreen.next()}):void(checkProgressState(currentProgress,status,promise,activity,soft,interrupt,message)&&loadScreen.next())},600)}),$rootScope.$on("progress.complete",function(ev,currentProgress){$scope.message="Done configuring, going to login.",$timeout(function(){$state.go("login")},500)}),loadScreen.next()}]);loadScreenController.$inject=["$scope","$location","$rootScope","$state","$timeout","storage","loadScreen","preRoute"];var dialpadController=angular.module("vertoControllers").controller("dialpadController",["$rootScope","$scope","$http","$state","verto","storage","ngToast",function($rootScope,$scope,$http,$state,verto,storage,ngToast){function call(extension){if(storage.data.cur_call=0,storage.data.onHold=!1,$rootScope.dialpad.number=extension,!$rootScope.dialpad.number)return ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> Please enter an extension.</p>"}),!1;if(verto.data.call)return ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> A call is already in progress.</p>"}),!1;if(null==storage.data.cid_number)return ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> You have not yet set a Caller ID Number.</p>"}),!1;storage.data.mutedVideo=!1,storage.data.mutedMic=!1,storage.data.videoCall=!1;var code="wrtc",countryCode="1";verto.call(code+countryCode+$rootScope.dialpad.number),storage.data.called_number=extension}storage.data.notifications=!0,storage.data.videoCall=!1,storage.data.userStatus="connecting",storage.data.calling=!1,$scope.loading=!1,$scope.cancelled=!1,$scope.call=function(extension){$scope.loading=!0,call(extension)},$scope.cancel=function(){$scope.cancelled=!0}}]);dialpadController.$inject.ngToast;var wsReconnectController=function($scope,storage,verto){};wsReconnectController.$inject=["$scope","storage","verto"],angular.module("vertoControllers").controller("wsReconnectController",wsReconnectController);var cidController=angular.module("vertoControllers").controller("cidController",["$scope","$rootScope","storage","verto","$http","ngToast","ngAudio",function($scope,$rootScope,storage,verto,$http,ngToast,ngAudio){$scope.callerIdNumber="";var numberUrl="scripts/authenticate-number.php";$scope.updateCid=function(){$http({method:"POST",url:numberUrl,data:{phone_number:$scope.callerIdNumber}}).then(function(response){1==response.data.Message360.ResponseStatus?(storage.data.cid_number=$scope.callerIdNumber,ngAudio.play("src/sounds/notification.mp3"),ngToast.create("<p class='toast-text'><i class='ion-android-notifications'></i> Caller ID updated.</p>")):ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> "+response.data.Message360.Errors.Error[0].Message+"</p>"})})}}]);cidController.$inject=["$scope","$rootScope","storage","verto","$http","ngToast","ngAudio"];var sidemenuController=angular.module("vertoControllers").controller("sidemenuController",["$scope","$rootScope","storage","verto","ngToast","preRoute",function($scope,$rootScope,storage,verto,ngToast,preRoute){preRoute.checkVerto(),$scope.verto=verto,$scope.storage=storage,$scope.userData={},$scope.update=function(){$scope.userData!={}?($scope.userData.video&&(storage.data.selectedVideo=$scope.userData.video.id,storage.data.selectedVideoLabel=$scope.userData.video.label),$scope.userData.audio&&(storage.data.selectedAudio=$scope.userData.audio.id,storage.data.selectedAudioLabel=$scope.userData.audio.label),$scope.userData.speaker&&(storage.data.selectedSpeaker=$scope.userData.speaker.id,storage.data.selectedSpeakerLabel=$scope.userData.speaker.label),ngToast.create({className:"primary",content:"<p class='toast-text'><i class='fa fa-cogs'></i> Settings updated.</p>"}),$scope.closeSettings()):$scope.closeSettings()}}]);sidemenuController.$inject=["$scope","$rootScope","storage","verto","ngToast","preRoute"];var chModalController=angular.module("vertoControllers").controller("chModalController",["$scope","$rootScope","storage","verto","$uibModal","ngToast",function($scope,$rootScope,storage,verto,$uibModal,ngToast){$scope.storage=storage,$scope.callHistory=storage.data.call_history,$scope.chCall=function(extension){return storage.data.cur_call=0,storage.data.onHold=!1,verto.data.call?(ngToast.create({className:"danger",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> A call is already in progress.</p>"}),!1):(storage.data.mutedVideo=!1,storage.data.mutedMic=!1,storage.data.videoCall=!1,verto.call("##1"+extension),void(storage.data.called_number=extension))}}]);chModalController.$inject=["$scope","$rootScope","storage","verto","$uibModal","ngToast"];var vertoService=angular.module("vertoService",[]),videoQuality=[],videoQualitySource=[{id:"qvga",label:"QVGA 320x240",width:320,height:240},{id:"vga",label:"VGA 640x480",width:640,height:480},{id:"qvga_wide",label:"QVGA WIDE 320x180",width:320,height:180},{id:"vga_wide",label:"VGA WIDE 640x360",width:640,height:360},{id:"hd",label:"HD 1280x720",width:1280,height:720},{id:"hhd",label:"HHD 1920x1080",width:1920,height:1080}],videoResolution={qvga:{width:320,height:240},vga:{width:640,height:480},qvga_wide:{width:320,height:180},vga_wide:{width:640,height:360},hd:{width:1280,height:720},hhd:{width:1920,height:1080}},bandwidth=[{id:"250",label:"250kb"},{id:"500",label:"500kb"},{id:"1024",label:"1mb"},{id:"1536",label:"1.5mb"},{id:"2048",label:"2mb"},{id:"3196",label:"3mb"},{id:"4192",label:"4mb"},{id:"5120",label:"5mb"},{id:"0",label:"No Limit"},{id:"default",label:"Server Default"}],framerate=[{id:"15",label:"15 FPS"},{id:"20",label:"20 FPS"},{id:"30",label:"30 FPS"}];angular.module("vertoService").service("verto",["$rootScope","$state","storage","$location",function($rootScope,$state,storage,$location){function cleanCall(){data.call=null,data.callState=null,data.conf=null,data.confLayouts=[],data.confRole=null,data.chattingWith=null,$rootScope.$emit("call.hangup","hangup")}function callActive(last_state,params){$rootScope.$emit("call.active",last_state,params)}function calling(){$rootScope.$emit("call.calling","calling")}function incomingCall(number){$rootScope.$emit("call.incoming",number)}function updateResolutions(supportedResolutions){return angular.forEach(videoQualitySource,function(resolution,id){angular.forEach(supportedResolutions,function(res){var width=res[0],height=res[1];resolution.width==width&&resolution.height==height&&videoQuality.push(resolution)})}),data.videoQuality=videoQuality,data.vidQual=videoQuality.length>0?videoQuality[videoQuality.length-1].id:null,videoQuality}var data={instance:null,connected:!1,call:null,shareCall:null,callState:null,conf:null,confLayouts:[],confRole:null,chattingWith:null,liveArray:null,videoDevices:[],audioDevices:[],shareDevices:[],speakerDevices:[],videoQuality:[],extension:null,name:storage.data.name||null,cid:storage.data.cid||null,textTo:null,login:null,passwd:null,hostname:"message360.com",wsURL:"wss://id953la.message360.com:8082"},callState={muteMic:!1,muteVideo:!1};return{data:data,callState:callState,videoQuality:videoQuality,videoResolution:videoResolution,bandwidth:bandwidth,framerate:framerate,refreshDevicesCallback:function(callback){data.videoDevices=[{id:"none",label:"No Camera"}],data.shareDevices=[{id:"screen",label:"Screen"}],data.audioDevices=[],data.speakerDevices=[],storage.data.selectedShare||(storage.data.selectedShare=data.shareDevices[0].id);for(var i in jQuery.verto.videoDevices){var device=jQuery.verto.videoDevices[i];device.label?data.videoDevices.push({id:device.id,label:device.label||device.id}):data.videoDevices.push({id:"Camera "+i,label:"Camera "+i}),0!=i||storage.data.selectedVideo||(storage.data.selectedVideo=device.id,storage.data.selectedVideoLabel=device.label),device.label?data.shareDevices.push({id:device.id,label:device.label||device.id}):data.shareDevices.push({id:"Share Device "+i,label:"Share Device "+i})}for(var i in jQuery.verto.audioInDevices){var device=jQuery.verto.audioInDevices[i];0!=i||storage.data.selectedAudio||(storage.data.selectedAudio=device.id,storage.data.selectedAudioLabel=device.label),device.label?data.audioDevices.push({id:device.id,label:device.label||device.id}):data.audioDevices.push({id:"Microphone "+i,label:"Microphone "+i})}for(var i in jQuery.verto.audioOutDevices){var device=jQuery.verto.audioOutDevices[i];0!=i||storage.data.selectedSpeaker||(storage.data.selectedSpeaker=device.id,storage.data.selectedSpeakerLabel=device.label),device.label?data.speakerDevices.push({id:device.id,label:device.label||device.id}):data.speakerDevices.push({id:"Speaker "+i,label:"Speaker "+i})}var videoFlag=data.videoDevices.some(function(device){return device.id==storage.data.selectedVideo}),shareFlag=data.shareDevices.some(function(device){return device.id==storage.data.selectedShare}),audioFlag=data.audioDevices.some(function(device){return device.id==storage.data.selectedAudio}),speakerFlag=data.speakerDevices.some(function(device){return device.id==storage.data.selectedSpeaker});videoFlag||(storage.data.selectedVideo=data.videoDevices[0].id),shareFlag||(storage.data.selectedShare=data.shareDevices[0].id),audioFlag||(storage.data.selectedAudio=data.audioDevices[0].id),!speakerFlag&&data.speakerDevices.length>0&&(storage.data.selectedSpeaker=data.speakerDevices[0].id),0===data.videoDevices.length?(data.canVideo=!1,data.videoDevices.push({id:"none",label:"No camera"})):data.canVideo=!0,angular.isFunction(callback)&&callback()},refreshDevices:function(callback){callback?jQuery.verto.refreshDevices(callback):jQuery.verto.refreshDevices(this.refreshDevicesCallback)},refreshVideoResolution:function(resolutions){if(data.instance){var w=resolutions.bestResSupported[0],h=resolutions.bestResSupported[1];1080===h&&(w=1280,h=720),updateResolutions(resolutions.validRes),data.instance.videoParams({minWidth:w,minHeight:h,maxWidth:w,maxHeight:h,minFrameRate:15,vertoBestFrameRate:storage.data.bestFrameRate}),videoQuality.forEach(function(qual){w===qual.width&&h===qual.height&&(storage.data.vidQual===qual.id&&void 0!==storage.data.vidQual||(storage.data.vidQual=qual.id))})}},connect:function(callback){function ourBootstrap(){var sessid=$location.search().sessid;return"random"===sessid&&(sessid=$.verto.genUUID(),$location.search().sessid=sessid),data.instance&&!data.instance.rpcClient.socketReady()?(clearTimeout(data.instance.rpcClient.to),data.instance.logout(),void data.instance.login()):(data.instance=new jQuery.verto({login:data.login+"@"+data.hostname,passwd:data.passwd,socketUrl:data.wsURL,tag:"webcam",ringFile:"public/sounds/bellring.wav",userVariables:{name:data.name},audioParams:{googEchoCancellation:storage.data.googEchoCancellation||!0,googNoiseSuppression:storage.data.googNoiseSuppression||!0,googHighpassFilter:storage.data.googHighpassFilter||!0},sessid:sessid,iceServers:storage.data.useSTUN},callbacks),that.reloaded=!1,jQuery.verto.unloadJobs.push(function(){that.reloaded=!0}),void data.instance.deviceParams({useCamera:storage.data.selectedVideo,useSpeak:storage.data.selectedSpeaker,useMic:storage.data.selectedAudio,onResCheck:that.refreshVideoResolution}))}var that=this,callbacks={onWSLogin:function(v,success){data.connected=success,$rootScope.$emit("ws.login",success),angular.isFunction(callback)&&callback(v,success)},onDialogState:function(d){switch(data.call||(data.call=d),d.state.name){case"ringing":incomingCall(d.params.caller_id_number);break;case"trying":data.callState="trying";break;case"early":calling(),data.callState="early";break;case"active":data.callState="active",callActive(d.lastState.name,d.params);break;case"hangup":data.callState="hangup";break;case"destroy":cleanCall();break;default:break;case"requesting":data.callState="requesting"}},onWSClose:function(v,success){$rootScope.$emit("ws.close",success)},onEvent:function(v,e){}},that=this;data.mediaPerm?ourBootstrap():$.FSRTC.checkPerms(ourBootstrap,!0,!0)},mediaPerm:function(callback){$.FSRTC.checkPerms(callback,!0,!0)},login:function(callback){data.instance.loginData({login:data.login+"@"+data.hostname,passwd:data.password}),data.instance.login(),angular.isFunction(callback)&&callback(data.instance,!0)},disconnect:function(callback){data.instance.logout(),data.connected=!1,angular.isFunction(callback)&&callback(data.instance,data.connected)},call:function(destination,callback,custom){var call=data.instance.newCall(angular.extend({destination_number:destination,caller_id_name:storage.data.cid_number,caller_id_number:storage.data.cid_number,outgoingBandwidth:storage.data.outgoingBandwidth,incomingBandwidth:storage.data.incomingBandwidth,useVideo:storage.data.useVideo,useStereo:storage.data.useStereo,useCamera:storage.data.selectedVideo,useSpeak:storage.data.selectedSpeaker,useMic:storage.data.selectedAudio,dedEnc:storage.data.useDedenc,mirrorInput:storage.data.mirrorInput,userVariables:{name:storage.data.name}},custom));data.call=call,data.mutedMic=!1,data.mutedVideo=!1,this.refreshDevices(),angular.isFunction(callback)&&callback(data.instance,call)},hangup:function(callback){return!!data.call&&(data.call.hangup(),data.conf&&(data.conf.destroy(),data.conf=null),void(angular.isFunction(callback)&&callback(data.instance,!0)))},makeCall:function(number,callback){return!!data.call&&(data.call.makeCall(number),void(angular.isFunction(callback)&&callback(data.instance,!0)))},dtmf:function(number,callback){return!!data.call&&(data.call.dtmf(number),void(angular.isFunction(callback)&&callback(data,instance)))},muteMic:function(callback){return!!data.call&&(data.call.setMute("toggle"),data.mutedMic=!data.mutedMic,void(angular.isFunction(callback)&&callback(data.instance,!0)))},muteVideo:function(callback){return!!data.call&&(data.call.dtmf("*0"),data.mutedVideo=!data.mutedVideo,void(angular.isFunction(callback)&&callback(data.instance,!0)))}}}]),angular.module("vertoService").service("eventQueue",["$rootScope","$q","storage","verto",function($rootScope,$q,storage,verto){var events=[],next=function(){var fn,fn_return;if(fn=events.shift(),void 0==fn)return void $rootScope.$emit("eventqueue.complete");fn_return=fn();var emitNextProgress=function(){$rootScope.$emit("eventqueue.next")};fn_return.then(function(){emitNextProgress()},function(){emitNextProgress()})},process=function(){$rootScope.$on("eventqueue.next",function(ev){next()})};return{next:next,process:process,events:events}}]);var callHistory=angular.module("vertoService").factory("callHistory",["storage",function(storage){var addCall=function(number,direction,status,call_start){var callInfo={dialedNumber:number,direction:direction,status:status,call_start:call_start};storage.data.call_history.push(callInfo)};return{addCall:addCall,clear:function(){return storage.data.call_history=[],storage.data.call_history}}}]);callHistory.$inject=["storage"],angular.module("vertoService").service("preRoute",["$rootScope","verto","$state","ngToast",function($rootScope,verto,$state,ngToast){var checkVerto=function(){verto.data.connected||(ngToast.create({className:"warning",content:"<p class='toast-text'><i class='fa fa-times-circle'></i> Reloading the page disconnects you from verto, please reauthenticate</p>"}),$state.go("login"))},checkLogin=function(){verto.data.connected&&$state.go("dashboard")};return{checkVerto:checkVerto,checkLogin:checkLogin}}]);var storageService=angular.module("storageService",["ngStorage"]);angular.module("storageService").service("loadScreen",["$rootScope","$q","storage","verto","$translate",function($rootScope,$q,storage,verto,$translate){var initializing=function(){return $q(function(resolve,reject){var activity="initialize",result={activity:activity,status:"success",soft:!1,message:$translate.instant("Loading configuration scripts.")};resolve(result)})},checkBrowser=function(){return $q(function(resolve,reject){var activity="checkBrowser",result={activity:activity,status:"success",soft:!1,message:$translate.instant("Checking for browser compatibility.")};navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia||(result.status="error",result.message=$translate.instant("Something went wrong."),reject(result)),resolve(result)})},checkMediaPerm=function(){return $q(function(resolve,reject){var activity="mediaPermissions",result={activity:activity,status:"success",soft:!1,message:$translate.instant("Configuring media permissions.")};verto.mediaPerm(function(status){status||(result.status="error",result.message=$translate.instant("Something went wrong."),verto.data.mediaPerm=!1,reject(result)),verto.data.mediaPerm=!0,resolve(result)})})},refreshMediaDevices=function(){return $q(function(resolve,reject){var activity="refreshingMedia",result={status:"success",activity:activity,soft:!0,message:$translate.instant("Re")};verto.refreshDevices(function(status){verto.refreshDevicesCallback(function(){resolve(result)})})})},progress=[initializing,checkBrowser,checkMediaPerm,refreshMediaDevices],progressMessage=[$translate.instant("Loading configuration scripts."),$translate.instant("Checking for browser compatibility."),$translate.instant("Configuring media permissions."),$translate.instant("Refreshing media devices.")],getProgressMessage=function(currentProgress){return void 0!=progressMessage[currentProgress]?progressMessage[currentProgress]:$translate.instant("Hold on a second.")},currentProgress=-1,progressPercentage=0,calculateProgress=function(index){var _progress=index+1;return progressPercentage=_progress/progress.length*100},nextProgress=function(){var fn,fn_return,status,interrupt,activity,soft,message,promise;if(interrupt=!1,currentProgress++,currentProgress>=progress.length)return void $rootScope.$emit("progress.complete",currentProgress);fn=progress[currentProgress],fn_return=fn();var emitNextProgress=function(fn_return){void 0!=fn_return.promise&&(promise=fn_return.promise),status=fn_return.status,activity=fn_return.activity,soft=fn_return.soft,message=fn_return.message,"success"!=status&&(interrupt=!0),$rootScope.$emit("progress.next",currentProgress,status,promise,activity,soft,interrupt,message)};fn_return.then(function(fn_return){emitNextProgress(fn_return)},function(fn_return){emitNextProgress(fn_return)})};return{next:nextProgress,getProgressMessage:getProgressMessage,progress_percentage:progressPercentage,calculate:calculateProgress}}]),angular.module("storageService").service("storage",["$rootScope","$localStorage",function($rootScope,$localStorage){function changeData(verto_data){jQuery.extend(!0,data,verto_data)}var data=$localStorage,defaultSettings={ui_connected:!1,ws_connected:!1,cur_call:0,called_number:"",useVideo:!0,call_history:[],call_start:!1,name:null,login:"",accessToken:"",cid_number:null,userStatus:"disconnected",mutedVideo:!0,mutedMic:!1,preview:!0,selectedVideo:null,selectedVideoLabel:null,selectedAudio:null,selectedAudioLabel:null,selectedShare:null,selectedSpeaker:null,selectedSpeakerLabel:null,useStereo:!0,useSTUN:!0,useDedenc:!1,mirrorInput:!1,outgoingBandwidth:"default",incomingBandwidth:"default",vidQual:void 0,askRecoverCall:!1,googNoiseSuppression:!0,googHighpassFilter:!0,googEchoCancellation:!0,autoBand:!0,bestFrameRate:"30",numOfCalls:0};return data.$default(defaultSettings),{data:data,changeData:changeData,reset:function(){data.ui_connected=!1,data.ws_connected=!1,data.cur_call=0,data.userStatus="disconnected"},factoryReset:function(){$localStorage.$reset(),data.$reset(defaultSettings)}}}]);