function createAudioMeter(audioContext,clipLevel,averaging,clipLag){var processor=audioContext.createScriptProcessor(512);return processor.onaudioprocess=volumeAudioProcess,processor.clipping=!1,processor.lastClip=0,processor.volume=0,processor.clipLevel=clipLevel||.98,processor.averaging=averaging||.95,processor.clipLag=clipLag||750,processor.connect(audioContext.destination),processor.checkClipping=function(){return!!this.clipping&&(this.lastClip+this.clipLag<window.performance.now()&&(this.clipping=!1),this.clipping)},processor.shutdown=function(){this.disconnect(),this.onaudioprocess=null},processor}function volumeAudioProcess(event){for(var x,buf=event.inputBuffer.getChannelData(0),bufLength=buf.length,sum=0,i=0;i<bufLength;i++)x=buf[i],Math.abs(x)>=this.clipLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),sum+=x*x;var rms=Math.sqrt(sum/bufLength);this.volume=Math.max(rms,this.volume*this.averaging)}!function($){$.JsonRpcClient=function(options){var self=this;this.options=$.extend({ajaxUrl:null,socketUrl:null,onmessage:null,login:null,passwd:null,sessid:null,loginParams:null,userVariables:null,getSocket:function(onmessage_cb){return self._getSocket(onmessage_cb)}},options),self.ws_cnt=0,this.wsOnMessage=function(event){self._wsOnMessage(event)}},$.JsonRpcClient.prototype._ws_socket=null,$.JsonRpcClient.prototype._ws_callbacks={},$.JsonRpcClient.prototype._current_id=1,$.JsonRpcClient.prototype.speedTest=function(bytes,cb){var socket=this.options.getSocket(this.wsOnMessage);if(null!==socket){this.speedCB=cb,this.speedBytes=bytes,socket.send("#SPU "+bytes);var i,loops=bytes/1024,rem=bytes%1024,data=new Array(1024).join(".");for(i=0;i<loops;i++)socket.send("#SPB "+data);rem&&socket.send("#SPB "+data),socket.send("#SPE")}},$.JsonRpcClient.prototype.call=function(method,params,success_cb,error_cb){params||(params={}),this.options.sessid&&(params.sessid=this.options.sessid);var request={jsonrpc:"2.0",method:method,params:params,id:this._current_id++};success_cb||(success_cb=function(e){console.log("Success: ",e)}),error_cb||(error_cb=function(e){console.log("Error: ",e)});var socket=this.options.getSocket(this.wsOnMessage);if(null!==socket)return void this._wsCall(socket,request,success_cb,error_cb);if(null===this.options.ajaxUrl)throw"$.JsonRpcClient.call used with no websocket and no http endpoint.";$.ajax({type:"POST",url:this.options.ajaxUrl,data:$.toJSON(request),dataType:"json",cache:!1,success:function(data){"error"in data&&error_cb(data.error,this),success_cb(data.result,this)},error:function(jqXHR,textStatus,errorThrown){try{var response=$.parseJSON(jqXHR.responseText);"console"in window&&console.log(response),error_cb(response.error,this)}catch(err){error_cb({error:jqXHR.responseText},this)}}})},$.JsonRpcClient.prototype.notify=function(method,params){this.options.sessid&&(params.sessid=this.options.sessid);var request={jsonrpc:"2.0",method:method,params:params},socket=this.options.getSocket(this.wsOnMessage);if(null!==socket)return void this._wsCall(socket,request);if(null===this.options.ajaxUrl)throw"$.JsonRpcClient.notify used with no websocket and no http endpoint.";$.ajax({type:"POST",url:this.options.ajaxUrl,data:$.toJSON(request),dataType:"json",cache:!1})},$.JsonRpcClient.prototype.batch=function(callback,all_done_cb,error_cb){var batch=new $.JsonRpcClient._batchObject(this,all_done_cb,error_cb);callback(batch),batch._execute()},$.JsonRpcClient.prototype.socketReady=function(){return!(null===this._ws_socket||this._ws_socket.readyState>1)},$.JsonRpcClient.prototype.closeSocket=function(){var self=this;self.socketReady()&&(self._ws_socket.onclose=function(w){console.log("Closing Socket")},self._ws_socket.close())},$.JsonRpcClient.prototype.loginData=function(params){var self=this;self.options.login=params.login,self.options.passwd=params.passwd,self.options.loginParams=params.loginParams,self.options.userVariables=params.userVariables},$.JsonRpcClient.prototype.connectSocket=function(onmessage_cb){var self=this;return self.to&&clearTimeout(self.to),self.socketReady()||(self.authing=!1,self._ws_socket&&delete self._ws_socket,self._ws_socket=new WebSocket(self.options.socketUrl),self._ws_socket&&(self._ws_socket.onmessage=onmessage_cb,self._ws_socket.onclose=function(w){self.ws_sleep||(self.ws_sleep=1e3),self.options.onWSClose&&self.options.onWSClose(self),console.error("Websocket Lost "+self.ws_cnt+" sleep: "+self.ws_sleep+"msec"),self.to=setTimeout(function(){console.log("Attempting Reconnection...."),self.connectSocket(onmessage_cb)},self.ws_sleep),self.ws_cnt++,self.ws_sleep<3e3&&self.ws_cnt%10===0&&(self.ws_sleep+=1e3)},self._ws_socket.onopen=function(){self.to&&clearTimeout(self.to),self.ws_sleep=1e3,self.ws_cnt=0,self.options.onWSConnect&&self.options.onWSConnect(self);for(var req;req=$.JsonRpcClient.q.pop();)self._ws_socket.send(req)})),!!self._ws_socket},$.JsonRpcClient.prototype._getSocket=function(onmessage_cb){return null!==this.options.socketUrl&&"WebSocket"in window?(this.connectSocket(onmessage_cb),this._ws_socket):null},$.JsonRpcClient.q=[],$.JsonRpcClient.prototype._wsCall=function(socket,request,success_cb,error_cb){var request_json=$.toJSON(request);socket.readyState<1?(self=this,$.JsonRpcClient.q.push(request_json)):socket.send(request_json),"id"in request&&"undefined"!=typeof success_cb&&(this._ws_callbacks[request.id]={request:request_json,request_obj:request,success_cb:success_cb,error_cb:error_cb})},$.JsonRpcClient.prototype._wsOnMessage=function(event){var response;if("#"!=event.data[0]||"S"!=event.data[1]||"P"!=event.data[2]){try{if(response=$.parseJSON(event.data),"object"==typeof response&&"jsonrpc"in response&&"2.0"===response.jsonrpc){if("result"in response&&this._ws_callbacks[response.id]){var success_cb=this._ws_callbacks[response.id].success_cb;return delete this._ws_callbacks[response.id],void success_cb(response.result,this)}if("error"in response&&this._ws_callbacks[response.id]){var error_cb=this._ws_callbacks[response.id].error_cb,orig_req=this._ws_callbacks[response.id].request;return!self.authing&&response.error.code==-32e3&&self.options.login&&self.options.passwd?(self.authing=!0,void this.call("login",{login:self.options.login,passwd:self.options.passwd,loginParams:self.options.loginParams,userVariables:self.options.userVariables},"login"==this._ws_callbacks[response.id].request_obj.method?function(e){self.authing=!1,console.log("logged in"),delete self._ws_callbacks[response.id],self.options.onWSLogin&&self.options.onWSLogin(!0,self)}:function(e){self.authing=!1,console.log("logged in, resending request id: "+response.id);var socket=self.options.getSocket(self.wsOnMessage);null!==socket&&socket.send(orig_req),self.options.onWSLogin&&self.options.onWSLogin(!0,self)},function(e){console.log("error logging in, request id:",response.id),delete self._ws_callbacks[response.id],error_cb(response.error,this),self.options.onWSLogin&&self.options.onWSLogin(!1,self)})):(delete this._ws_callbacks[response.id],void error_cb(response.error,this))}}}catch(err){return void console.log("ERROR: "+err)}if("function"==typeof this.options.onmessage){event.eventData=response,event.eventData||(event.eventData={});var reply=this.options.onmessage(event);if(reply&&"object"==typeof reply&&event.eventData.id){var msg={jsonrpc:"2.0",id:event.eventData.id,result:reply},socket=self.options.getSocket(self.wsOnMessage);null!==socket&&socket.send($.toJSON(msg))}}}else if("U"==event.data[3])this.up_dur=parseInt(event.data.substring(4));else if(this.speedCB&&"D"==event.data[3]){this.down_dur=parseInt(event.data.substring(4));var up_kps=(8*this.speedBytes/(this.up_dur/1e3)/1024).toFixed(0),down_kps=(8*this.speedBytes/(this.down_dur/1e3)/1024).toFixed(0);console.info("Speed Test: Up: "+up_kps+" Down: "+down_kps),this.speedCB(event,{upDur:this.up_dur,downDur:this.down_dur,upKPS:up_kps,downKPS:down_kps}),this.speedCB=null}},$.JsonRpcClient._batchObject=function(jsonrpcclient,all_done_cb,error_cb){this._requests=[],this.jsonrpcclient=jsonrpcclient,this.all_done_cb=all_done_cb,this.error_cb="function"==typeof error_cb?error_cb:function(){}},$.JsonRpcClient._batchObject.prototype.call=function(method,params,success_cb,error_cb){params||(params={}),this.options.sessid&&(params.sessid=this.options.sessid),success_cb||(success_cb=function(e){console.log("Success: ",e)}),error_cb||(error_cb=function(e){console.log("Error: ",e)}),this._requests.push({request:{jsonrpc:"2.0",method:method,params:params,id:this.jsonrpcclient._current_id++},success_cb:success_cb,error_cb:error_cb})},$.JsonRpcClient._batchObject.prototype.notify=function(method,params){this.options.sessid&&(params.sessid=this.options.sessid),this._requests.push({request:{jsonrpc:"2.0",method:method,params:params}})},$.JsonRpcClient._batchObject.prototype._execute=function(){var self=this;if(0!==this._requests.length){var call,success_cb,error_cb,batch_request=[],handlers={},i=0,socket=self.jsonrpcclient.options.getSocket(self.jsonrpcclient.wsOnMessage);if(null!==socket){for(i=0;i<this._requests.length;i++)call=this._requests[i],success_cb="success_cb"in call?call.success_cb:void 0,error_cb="error_cb"in call?call.error_cb:void 0,self.jsonrpcclient._wsCall(socket,call.request,success_cb,error_cb);return void("function"==typeof all_done_cb&&all_done_cb(result))}for(i=0;i<this._requests.length;i++)call=this._requests[i],batch_request.push(call.request),"id"in call.request&&(handlers[call.request.id]={success_cb:call.success_cb,error_cb:call.error_cb});if(success_cb=function(data){self._batchCb(data,handlers,self.all_done_cb)},null===self.jsonrpcclient.options.ajaxUrl)throw"$.JsonRpcClient.batch used with no websocket and no http endpoint.";$.ajax({url:self.jsonrpcclient.options.ajaxUrl,data:$.toJSON(batch_request),dataType:"json",cache:!1,type:"POST",error:function(jqXHR,textStatus,errorThrown){self.error_cb(jqXHR,textStatus,errorThrown)},success:success_cb})}},$.JsonRpcClient._batchObject.prototype._batchCb=function(result,handlers,all_done_cb){for(var i=0;i<result.length;i++){var response=result[i];"error"in response?null!==response.id&&response.id in handlers?handlers[response.id].error_cb(response.error,this):"console"in window&&console.log(response):!(response.id in handlers)&&"console"in window?console.log(response):handlers[response.id].success_cb(response.result,this)}"function"==typeof all_done_cb&&all_done_cb(result)}}(jQuery),function($){function findLine(sdpLines,prefix,substr){return findLineInRange(sdpLines,0,-1,prefix,substr)}function findLineInRange(sdpLines,startLine,endLine,prefix,substr){for(var realEndLine=endLine!=-1?endLine:sdpLines.length,i=startLine;i<realEndLine;++i)if(0===sdpLines[i].indexOf(prefix)&&(!substr||sdpLines[i].toLowerCase().indexOf(substr.toLowerCase())!==-1))return i;return null}function getCodecPayloadType(sdpLine){var pattern=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),result=sdpLine.match(pattern);return result&&2==result.length?result[1]:null}function setCompat(){$.FSRTC.moz=!!navigator.mozGetUserMedia,navigator.getUserMedia||(navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia)}function checkCompat(){return!!navigator.getUserMedia||(alert("This application cannot function in this browser."),!1)}function onStreamError(self,e){console.log("There has been a problem retrieving the streams - did you allow access? Check Device Resolution",e),doCallback(self,"onError",e)}function onStreamSuccess(self,stream){console.log("Stream Success"),doCallback(self,"onStream",stream)}function onICE(self,candidate){self.mediaData.candidate=candidate,self.mediaData.candidateList.push(self.mediaData.candidate),doCallback(self,"onICE")}function doCallback(self,func,arg){func in self.options.callbacks&&self.options.callbacks[func](self,arg)}function onICEComplete(self,candidate){console.log("ICE Complete"),doCallback(self,"onICEComplete")}function onChannelError(self,e){console.error("Channel Error",e),doCallback(self,"onError",e)}function onICESDP(self,sdp){self.mediaData.SDP=self.stereoHack(sdp.sdp),console.log("ICE SDP"),doCallback(self,"onICESDP")}function onRemoteStream(self,stream){self.options.useVideo&&(self.options.useVideo.style.display="block");var element=self.options.useAudio;console.log("REMOTE STREAM",stream,element),"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):console.error("Error attaching stream to element."),self.options.useAudio.play(),self.remoteStream=stream}function onOfferSDP(self,sdp){self.mediaData.SDP=self.stereoHack(sdp.sdp),console.log("Offer SDP"),doCallback(self,"onOfferSDP")}function getMediaParams(obj){var audio;if(obj.options.useMic&&"none"===obj.options.useMic)console.log("Microphone Disabled"),audio=!1;else if(obj.options.videoParams&&obj.options.screenShare)console.error("SCREEN SHARE"),audio=!1;else if(audio={mandatory:{},optional:[]},"any"!==obj.options.useMic&&(audio.optional=[{sourceId:obj.options.useMic}]),obj.options.audioParams)for(var key in obj.options.audioParams){var con={};con[key]=obj.options.audioParams[key],audio.optional.push(con)}obj.options.useVideo&&obj.options.localVideo&&getUserMedia({constraints:{audio:!1,video:{mandatory:obj.options.videoParams,optional:[]}},localVideo:obj.options.localVideo,onsuccess:function(e){self.options.localVideoStream=e,console.log("local video ready")},onerror:function(e){console.error("local video error!")}});var video={},bestFrameRate=obj.options.videoParams.vertoBestFrameRate;delete obj.options.videoParams.vertoBestFrameRate,video={mandatory:obj.options.videoParams,optional:[]};var useVideo=obj.options.useVideo;return useVideo&&obj.options.useCamera&&"none"!==obj.options.useCamera?(video.optional||(video.optional=[]),"any"!==obj.options.useCamera&&video.optional.push({sourceId:obj.options.useCamera}),bestFrameRate&&(video.optional.push({minFrameRate:bestFrameRate}),video.optional.push({maxFrameRate:bestFrameRate}))):(console.log("Camera Disabled"),video=!1,useVideo=!1),{audio:audio,video:video,useVideo:useVideo}}function RTCPeerConnection(options){function ice_handler(){done=!0,gathering=null,options.onICEComplete&&options.onICEComplete(),"offer"==options.type?(!moz||!options.sentICESDP&&peer.localDescription.sdp.match(/a=candidate/)&&!x&&options.onICESDP)&&options.onICESDP(peer.localDescription):!x&&options.onICESDP&&options.onICESDP(peer.localDescription)}function createOffer(){options.onOfferSDP&&peer.createOffer(function(sessionDescription){sessionDescription.sdp=serializeSdp(sessionDescription.sdp),peer.setLocalDescription(sessionDescription),options.onOfferSDP(sessionDescription),moz&&options.onICESDP&&sessionDescription.sdp.match(/a=candidate/)&&(options.onICESDP(sessionDescription),options.sentICESDP=1)},onSdpError,constraints)}function createAnswer(){"answer"==options.type&&(peer.setRemoteDescription(new SessionDescription(options.offerSDP),onSdpSuccess,onSdpError),peer.createAnswer(function(sessionDescription){sessionDescription.sdp=serializeSdp(sessionDescription.sdp),peer.setLocalDescription(sessionDescription),options.onAnswerSDP&&options.onAnswerSDP(sessionDescription)},onSdpError,constraints))}function serializeSdp(sdp){return sdp}function openOffererChannel(){!options.onChannelMessage||moz&&!options.onOfferSDP||(_openOffererChannel(),moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(stream){peer.addStream(stream),createOffer()},useless))}function _openOffererChannel(){channel=peer.createDataChannel(options.channel||"RTCDataChannel",moz?{}:{reliable:!1}),moz&&(channel.binaryType="blob"),setChannelEvents()}function setChannelEvents(){channel.onmessage=function(event){options.onChannelMessage&&options.onChannelMessage(event)},channel.onopen=function(){options.onChannelOpened&&options.onChannelOpened(channel)},channel.onclose=function(event){options.onChannelClosed&&options.onChannelClosed(event),console.warn("WebRTC DataChannel closed",event)},channel.onerror=function(event){options.onChannelError&&options.onChannelError(event),console.error("WebRTC DataChannel error",event)}}function openAnswererChannel(){peer.ondatachannel=function(event){channel=event.channel,channel.binaryType="blob",setChannelEvents()},moz&&navigator.mozGetUserMedia({audio:!0,fake:!0},function(stream){peer.addStream(stream),createAnswer()},useless)}function useless(){log("Error in fake:true")}function onSdpSuccess(){}function onSdpError(e){options.onChannelError&&options.onChannelError(e),console.error("sdp error:",e)}var gathering=!1,done=!1,w=window,PeerConnection=w.mozRTCPeerConnection||w.webkitRTCPeerConnection,SessionDescription=w.mozRTCSessionDescription||w.RTCSessionDescription,IceCandidate=w.mozRTCIceCandidate||w.RTCIceCandidate,STUN={url:moz?"stun:23.21.150.121":"stun:stun.l.google.com:19302"},iceServers=null;if(options.iceServers){var tmp=options.iceServers;"boolean"==typeof tmp&&(tmp=null),!tmp||"object"==typeof tmp&&tmp.constructor===Array||(console.warn("iceServers must be an array, reverting to default ice servers"),tmp=null),iceServers={iceServers:tmp||[STUN]},moz||tmp||(iceServers.iceServers=[STUN])}var optional={optional:[]};moz||(optional.optional=[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!!options.onChannelMessage}]);var peer=new PeerConnection(iceServers,optional);openOffererChannel();var x=0;if(peer.onicecandidate=function(event){done||(gathering||(gathering=setTimeout(ice_handler,1e3)),event?event.candidate&&options.onICE(event.candidate):(done=!0,gathering&&(clearTimeout(gathering),gathering=null),ice_handler()))},options.attachStream&&peer.addStream(options.attachStream),options.attachStreams&&options.attachStream.length)for(var streams=options.attachStreams,i=0;i<streams.length;i++)peer.addStream(streams[i]);peer.onaddstream=function(event){var remoteMediaStream=event.stream;remoteMediaStream.onended=function(){options.onRemoteStreamEnded&&options.onRemoteStreamEnded(remoteMediaStream)},options.onRemoteStream&&options.onRemoteStream(remoteMediaStream)};var constraints=options.constraints||{offerToReceiveAudio:!0,offerToReceiveVideo:!0};(options.onChannelMessage&&!moz||!options.onChannelMessage)&&(createOffer(),createAnswer());var channel;return options.onAnswerSDP&&moz&&options.onChannelMessage&&openAnswererChannel(),{addAnswerSDP:function(sdp,cbSuccess,cbError){peer.setRemoteDescription(new SessionDescription(sdp),cbSuccess?cbSuccess:onSdpSuccess,cbError?cbError:onSdpError)},addICE:function(candidate){peer.addIceCandidate(new IceCandidate({sdpMLineIndex:candidate.sdpMLineIndex,candidate:candidate.candidate}))},peer:peer,channel:channel,sendData:function(message){channel&&channel.send(message)},stop:function(){peer.close(),options.attachStream&&("function"==typeof options.attachStream.stop?options.attachStream.stop():options.attachStream.active=!1)}}}function getUserMedia(options){function streaming(stream){options.localVideo&&(options.localVideo[moz?"mozSrcObject":"src"]=moz?stream:window.webkitURL.createObjectURL(stream),options.localVideo.style.display="block"),options.onsuccess&&options.onsuccess(stream),media=stream}var media,n=navigator;return n.getMedia=n.webkitGetUserMedia||n.mozGetUserMedia,n.getMedia(options.constraints||{audio:!0,video:video_constraints},streaming,options.onerror||function(e){console.error(e)}),media}$.FSRTC=function(options){this.options=$.extend({useVideo:null,useStereo:!1,userData:null,localVideo:null,screenShare:!1,useCamera:"any",iceServers:!1,videoParams:{},audioParams:{},callbacks:{onICEComplete:function(){},onICE:function(){},onOfferSDP:function(){}}},options),this.audioEnabled=!0,this.videoEnabled=!0,this.mediaData={SDP:null,profile:{},candidateList:[]},moz?this.constraints={offerToReceiveAudio:"none"!==this.options.useSpeak,offerToReceiveVideo:!!this.options.useVideo}:this.constraints={optional:[{DtlsSrtpKeyAgreement:"true"}],mandatory:{OfferToReceiveAudio:"none"!==this.options.useSpeak,OfferToReceiveVideo:!!this.options.useVideo}},self.options.useVideo&&(self.options.useVideo.style.display="none"),setCompat(),checkCompat()},$.FSRTC.validRes=[],$.FSRTC.prototype.useVideo=function(obj,local){var self=this;obj?(self.options.useVideo=obj,self.options.localVideo=local,moz?self.constraints.offerToReceiveVideo=!0:self.constraints.mandatory.OfferToReceiveVideo=!0):(self.options.useVideo=null,self.options.localVideo=null,moz?self.constraints.offerToReceiveVideo=!1:self.constraints.mandatory.OfferToReceiveVideo=!1),self.options.useVideo&&(self.options.useVideo.style.display="none")},$.FSRTC.prototype.useStereo=function(on){var self=this;self.options.useStereo=on},$.FSRTC.prototype.stereoHack=function(sdp){var self=this;if(!self.options.useStereo)return sdp;var opusPayload,sdpLines=sdp.split("\r\n"),opusIndex=findLine(sdpLines,"a=rtpmap","opus/48000");if(!opusIndex)return sdp;opusPayload=getCodecPayloadType(sdpLines[opusIndex]);var fmtpLineIndex=findLine(sdpLines,"a=fmtp:"+opusPayload.toString());return null===fmtpLineIndex?sdpLines[opusIndex]=sdpLines[opusIndex]+"\r\na=fmtp:"+opusPayload.toString()+" stereo=1; sprop-stereo=1":sdpLines[fmtpLineIndex]=sdpLines[fmtpLineIndex].concat("; stereo=1; sprop-stereo=1"),sdp=sdpLines.join("\r\n")},$.FSRTC.prototype.answer=function(sdp,onSuccess,onError){this.peer.addAnswerSDP({type:"answer",sdp:sdp},onSuccess,onError)},$.FSRTC.prototype.stopPeer=function(){self.peer&&(console.log("stopping peer"),self.peer.stop())},$.FSRTC.prototype.stop=function(){var self=this;if(self.options.useVideo&&(self.options.useVideo.style.display="none",moz?self.options.useVideo.mozSrcObject=null:self.options.useVideo.src=""),self.localStream){if("function"==typeof self.localStream.stop)self.localStream.stop();else if(self.localStream.active){var tracks=self.localStream.getTracks();console.error(tracks),tracks.forEach(function(track,index){console.log(track),track.stop()})}self.localStream=null}if(self.options.localVideo&&(self.options.localVideo.style.display="none",moz?self.options.localVideo.mozSrcObject=null:self.options.localVideo.src=""),self.options.localVideoStream)if("function"==typeof self.options.localVideoStream.stop)self.options.localVideoStream.stop();else if(self.options.localVideoStream.active){var tracks=self.options.localVideoStream.getTracks();console.error(tracks),tracks.forEach(function(track,index){console.log(track),track.stop()})}self.peer&&(console.log("stopping peer"),self.peer.stop())},$.FSRTC.prototype.getMute=function(){var self=this;return self.audioEnabled},$.FSRTC.prototype.setMute=function(what){for(var self=this,audioTracks=self.localStream.getAudioTracks(),i=0,len=audioTracks.length;i<len;i++){switch(what){case"on":audioTracks[i].enabled=!0;break;case"off":audioTracks[i].enabled=!1;break;case"toggle":audioTracks[i].enabled=!audioTracks[i].enabled}self.audioEnabled=audioTracks[i].enabled}return!self.audioEnabled},$.FSRTC.prototype.getVideoMute=function(){var self=this;return self.videoEnabled},$.FSRTC.prototype.setVideoMute=function(what){for(var self=this,videoTracks=self.localStream.getVideoTracks(),i=0,len=videoTracks.length;i<len;i++){switch(what){case"on":videoTracks[i].enabled=!0;break;case"off":videoTracks[i].enabled=!1;break;case"toggle":videoTracks[i].enabled=!videoTracks[i].enabled}self.videoEnabled=videoTracks[i].enabled}return!self.videoEnabled},$.FSRTC.prototype.createAnswer=function(params){function onSuccess(stream){self.localStream=stream,self.peer=RTCPeerConnection({type:self.type,attachStream:self.localStream,onICE:function(candidate){return onICE(self,candidate)},onICEComplete:function(){return onICEComplete(self)},onRemoteStream:function(stream){return onRemoteStream(self,stream)},onICESDP:function(sdp){return onICESDP(self,sdp)},onChannelError:function(e){return onChannelError(self,e)},constraints:self.constraints,iceServers:self.options.iceServers,offerSDP:{type:"offer",sdp:self.remoteSDP}}),onStreamSuccess(self)}function onError(e){onStreamError(self,e)}var self=this;self.type="answer",self.remoteSDP=params.sdp,console.debug("inbound sdp: ",params.sdp);var mediaParams=getMediaParams(self);console.log("Audio constraints",mediaParams.audio),console.log("Video constraints",mediaParams.video),self.options.useVideo&&self.options.localVideo&&getUserMedia({constraints:{audio:!1,video:{mandatory:self.options.videoParams,optional:[]}},localVideo:self.options.localVideo,onsuccess:function(e){self.options.localVideoStream=e,console.log("local video ready")},onerror:function(e){console.error("local video error!")}}),getUserMedia({constraints:{audio:mediaParams.audio,video:mediaParams.video},video:mediaParams.useVideo,onsuccess:onSuccess,onerror:onError})},$.FSRTC.prototype.call=function(profile){function onSuccess(stream){self.localStream=stream,screen&&(moz?self.constraints.OfferToReceiveVideo=!1:self.constraints.mandatory.OfferToReceiveVideo=!1),self.peer=RTCPeerConnection({type:self.type,attachStream:self.localStream,onICE:function(candidate){return onICE(self,candidate)},onICEComplete:function(){return onICEComplete(self)},onRemoteStream:screen?function(stream){}:function(stream){return onRemoteStream(self,stream)},onOfferSDP:function(sdp){return onOfferSDP(self,sdp)},onICESDP:function(sdp){return onICESDP(self,sdp)},onChannelError:function(e){return onChannelError(self,e)},constraints:self.constraints,iceServers:self.options.iceServers}),onStreamSuccess(self,stream)}function onError(e){onStreamError(self,e)}checkCompat();var self=this,screen=!1;self.type="offer",self.options.videoParams&&self.options.screenShare&&(screen=!0);var mediaParams=getMediaParams(self);console.log("Audio constraints",mediaParams.audio),console.log("Video constraints",mediaParams.video),mediaParams.audio||mediaParams.video?getUserMedia({constraints:{audio:mediaParams.audio,video:mediaParams.video},video:mediaParams.useVideo,onsuccess:onSuccess,onerror:onError}):onSuccess(null)},window.moz=!!navigator.mozGetUserMedia;var video_constraints={mandatory:{},optional:[]};$.FSRTC.resSupported=function(w,h){for(var i in $.FSRTC.validRes)if($.FSRTC.validRes[i][0]==w&&$.FSRTC.validRes[i][1]==h)return!0;return!1},$.FSRTC.bestResSupported=function(){var w=0,h=0;for(var i in $.FSRTC.validRes)$.FSRTC.validRes[i][0]>w&&$.FSRTC.validRes[i][1]>h&&(w=$.FSRTC.validRes[i][0],h=$.FSRTC.validRes[i][1]);return[w,h]};var resList=[[160,120],[320,180],[320,240],[640,360],[640,480],[1280,720],[1920,1080]],resI=0,ttl=0,checkRes=function(cam,func){if(resI>=resList.length){var res={validRes:$.FSRTC.validRes,bestResSupported:$.FSRTC.bestResSupported()};if(localStorage.setItem("res_"+cam,$.toJSON(res)),func)return func(res)}else{var video={mandatory:{},optional:[]};cam&&(video.optional=[{sourceId:cam}]),w=resList[resI][0],h=resList[resI][1],resI++,video.mandatory={minWidth:w,minHeight:h,maxWidth:w,maxHeight:h},getUserMedia({constraints:{audio:0==ttl++,video:video},onsuccess:function(e){e.getTracks().forEach(function(track){track.stop()}),console.info(w+"x"+h+" supported."),$.FSRTC.validRes.push([w,h]),checkRes(cam,func)},onerror:function(e){console.error(w+"x"+h+" not supported."),checkRes(cam,func)}})}};$.FSRTC.getValidRes=function(cam,func){var cached=localStorage.getItem("res_"+cam);if(cached){var cache=$.parseJSON(cached);return cache?($.FSRTC.validRes=cache.validRes,console.log("CACHED RES FOR CAM "+cam,cache)):console.error("INVALID CACHE"),func?func(cache):null}$.FSRTC.validRes=[],resI=0,checkRes(cam,func)},$.FSRTC.checkPerms=function(runtime,check_audio,check_video){getUserMedia({constraints:{audio:check_audio,video:check_video},onsuccess:function(e){e.getTracks().forEach(function(track){track.stop()}),console.info("media perm init complete"),runtime&&setTimeout(runtime,100,!0)},onerror:function(e){return check_video&&check_audio?(console.error("error, retesting with audio params only"),$.FSRTC.checkPerms(runtime,check_audio,!1)):(console.error("media perm init error"),void(runtime&&runtime(!1)))}})}}(jQuery),function($){function drop_bad(verto,channel){console.error("drop unauthorized channel: "+channel),delete verto.eventSUBS[channel]}function mark_ready(verto,channel){for(var j in verto.eventSUBS[channel])verto.eventSUBS[channel][j].ready=!0,console.log("subscribed to channel: "+channel),verto.eventSUBS[channel][j].readyHandler&&verto.eventSUBS[channel][j].readyHandler(verto,channel)}function do_subscribe(verto,channel,subChannels,sparams){var params=sparams||{},local=params.local,obj={eventChannel:channel,userData:params.userData,handler:params.handler,ready:!1,readyHandler:params.readyHandler,serno:SERNO++},isnew=!1;return verto.eventSUBS[channel]||(verto.eventSUBS[channel]=[],subChannels.push(channel),isnew=!0),verto.eventSUBS[channel].push(obj),local&&(obj.ready=!0,obj.local=!0),!isnew&&verto.eventSUBS[channel][0].ready&&(obj.ready=!0,obj.readyHandler&&obj.readyHandler(verto,channel)),{serno:obj.serno,eventChannel:channel}}function createMainModeratorMethods(){$.verto.conf.prototype.listVideoLayouts=function(){this.modCommand("list-videoLayouts",null,null)},$.verto.conf.prototype.play=function(file){this.modCommand("play",null,file)},$.verto.conf.prototype.stop=function(){this.modCommand("stop",null,"all")},$.verto.conf.prototype.record=function(file){this.modCommand("recording",null,["start",file])},$.verto.conf.prototype.stopRecord=function(){this.modCommand("recording",null,["stop","all"])},$.verto.conf.prototype.snapshot=function(file){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-write-png",null,file)},$.verto.conf.prototype.setVideoLayout=function(layout,canvasID){if(!this.params.hasVid)throw"Conference has no video";canvasID?this.modCommand("vid-layout",null,[layout,canvasID]):this.modCommand("vid-layout",null,layout)},$.verto.conf.prototype.kick=function(memberID){this.modCommand("kick",parseInt(memberID))},$.verto.conf.prototype.muteMic=function(memberID){this.modCommand("tmute",parseInt(memberID))},$.verto.conf.prototype.muteVideo=function(memberID){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("tvmute",parseInt(memberID))},$.verto.conf.prototype.presenter=function(memberID){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-res-id",parseInt(memberID),"presenter")},$.verto.conf.prototype.videoFloor=function(memberID){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-floor",parseInt(memberID),"force")},$.verto.conf.prototype.banner=function(memberID,text){if(!this.params.hasVid)throw"Conference has no video";this.modCommand("vid-banner",parseInt(memberID),escape(text))},$.verto.conf.prototype.volumeDown=function(memberID){this.modCommand("volume_out",parseInt(memberID),"down")},$.verto.conf.prototype.volumeUp=function(memberID){this.modCommand("volume_out",parseInt(memberID),"up")},$.verto.conf.prototype.gainDown=function(memberID){this.modCommand("volume_in",parseInt(memberID),"down")},$.verto.conf.prototype.gainUp=function(memberID){this.modCommand("volume_in",parseInt(memberID),"up")},$.verto.conf.prototype.transfer=function(memberID,exten){this.modCommand("transfer",parseInt(memberID),exten)},$.verto.conf.prototype.sendChat=function(message,type){var conf=this;conf.verto.rpcClient.call("verto.broadcast",{eventChannel:conf.params.laData.chatChannel,data:{action:"send",message:message,type:type}})}}function checkStateChange(oldS,newS){return!(newS!=$.verto.enum.state.purge&&!$.verto.enum.states[oldS.name][newS.name])}function find_name(id){for(var i in $.verto.audioOutDevices){var source=$.verto.audioOutDevices[i];if(source.id===id)return source.label}return id}var generateGUID="undefined"!=typeof window.crypto&&"undefined"!=typeof window.crypto.getRandomValues?function(){var buf=new Uint16Array(8);window.crypto.getRandomValues(buf);var S4=function(num){for(var ret=num.toString(16);ret.length<4;)ret="0"+ret;return ret};return S4(buf[0])+S4(buf[1])+"-"+S4(buf[2])+"-"+S4(buf[3])+"-"+S4(buf[4])+"-"+S4(buf[5])+S4(buf[6])+S4(buf[7]);
}:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})};$.verto=function(options,callbacks){var verto=this;$.verto.saved.push(verto),verto.options=$.extend({login:null,passwd:null,socketUrl:null,tag:null,localTag:null,videoParams:{},audioParams:{},loginParams:{},deviceParams:{onResCheck:null},userVariables:{},iceServers:!1,ringSleep:6e3,sessid:null},options),verto.options.deviceParams.useCamera&&$.FSRTC.getValidRes(verto.options.deviceParams.useCamera,verto.options.deviceParams.onResCheck),verto.options.deviceParams.useMic||(verto.options.deviceParams.useMic="any"),verto.options.deviceParams.useSpeak||(verto.options.deviceParams.useSpeak="any"),verto.options.sessid?verto.sessid=verto.options.sessid:(verto.sessid=localStorage.getItem("verto_session_uuid")||generateGUID(),localStorage.setItem("verto_session_uuid",verto.sessid)),verto.dialogs={},verto.callbacks=callbacks||{},verto.eventSUBS={},verto.rpcClient=new $.JsonRpcClient({login:verto.options.login,passwd:verto.options.passwd,socketUrl:verto.options.socketUrl,loginParams:verto.options.loginParams,userVariables:verto.options.userVariables,sessid:verto.sessid,onmessage:function(e){return verto.handleMessage(e.eventData)},onWSConnect:function(o){o.call("login",{})},onWSLogin:function(success){verto.callbacks.onWSLogin&&verto.callbacks.onWSLogin(verto,success)},onWSClose:function(success){verto.callbacks.onWSClose&&verto.callbacks.onWSClose(verto,success),verto.purge()}});var tag=verto.options.tag;"function"==typeof tag&&(tag=tag()),verto.options.ringFile&&verto.options.tag&&(verto.ringer=$("#"+tag)),verto.rpcClient.call("login",{})},$.verto.prototype.deviceParams=function(obj){var verto=this;for(var i in obj)verto.options.deviceParams[i]=obj[i];obj.useCamera&&$.FSRTC.getValidRes(verto.options.deviceParams.useCamera,obj?obj.onResCheck:void 0)},$.verto.prototype.videoParams=function(obj){var verto=this;for(var i in obj)verto.options.videoParams[i]=obj[i]},$.verto.prototype.iceServers=function(obj){var verto=this;verto.options.iceServers=obj},$.verto.prototype.loginData=function(params){var verto=this;verto.options.login=params.login,verto.options.passwd=params.passwd,verto.rpcClient.loginData(params)},$.verto.prototype.logout=function(msg){var verto=this;verto.rpcClient.closeSocket(),verto.callbacks.onWSClose&&verto.callbacks.onWSClose(verto,!1),verto.purge()},$.verto.prototype.login=function(msg){var verto=this;verto.logout(),verto.rpcClient.call("login",{})},$.verto.prototype.message=function(msg){var verto=this,err=0;return msg.to||(console.error("Missing To"),err++),msg.body||(console.error("Missing Body"),err++),!err&&(verto.sendMethod("verto.info",{msg:msg}),!0)},$.verto.prototype.processReply=function(method,success,e){var i,verto=this;switch(method){case"verto.subscribe":for(i in e.unauthorizedChannels)drop_bad(verto,e.unauthorizedChannels[i]);for(i in e.subscribedChannels)mark_ready(verto,e.subscribedChannels[i]);break;case"verto.unsubscribe":}},$.verto.prototype.sendMethod=function(method,params){var verto=this;verto.rpcClient.call(method,params,function(e){verto.processReply(method,!0,e)},function(e){verto.processReply(method,!1,e)})};var SERNO=1;$.verto.prototype.subscribe=function(channel,sparams){var verto=this,r=[],subChannels=[],params=sparams||{};if("string"==typeof channel)r.push(do_subscribe(verto,channel,subChannels,params));else for(var i in channel)r.push(do_subscribe(verto,channel,subChannels,params));return subChannels.length&&verto.sendMethod("verto.subscribe",{eventChannel:1==subChannels.length?subChannels[0]:subChannels,subParams:params.subParams}),r},$.verto.prototype.unsubscribe=function(handle){var i,verto=this;if(handle){var channel,unsubChannels={},sendChannels=[];if("string"==typeof handle)delete verto.eventSUBS[handle],unsubChannels[handle]++;else for(i in handle)if("string"==typeof handle[i])channel=handle[i],delete verto.eventSUBS[channel],unsubChannels[channel]++;else{var repl=[];channel=handle[i].eventChannel;for(var j in verto.eventSUBS[channel])verto.eventSUBS[channel][j].serno==handle[i].serno||repl.push(verto.eventSUBS[channel][j]);verto.eventSUBS[channel]=repl,0===verto.eventSUBS[channel].length&&(delete verto.eventSUBS[channel],unsubChannels[channel]++)}for(var u in unsubChannels)console.log("Sending Unsubscribe for: ",u),sendChannels.push(u);sendChannels.length&&verto.sendMethod("verto.unsubscribe",{eventChannel:1==sendChannels.length?sendChannels[0]:sendChannels})}else for(i in verto.eventSUBS)verto.eventSUBS[i]&&verto.unsubscribe(verto.eventSUBS[i])},$.verto.prototype.broadcast=function(channel,params){var verto=this,msg={eventChannel:channel,data:{}};for(var i in params)msg.data[i]=params[i];verto.sendMethod("verto.broadcast",msg)},$.verto.prototype.purge=function(callID){var i,verto=this,x=0;for(i in verto.dialogs)x||console.log("purging dialogs"),x++,verto.dialogs[i].setState($.verto.enum.state.purge);for(i in verto.eventSUBS)verto.eventSUBS[i]&&(console.log("purging subscription: "+i),delete verto.eventSUBS[i])},$.verto.prototype.hangup=function(callID){var verto=this;if(callID){var dialog=verto.dialogs[callID];dialog&&dialog.hangup()}else for(var i in verto.dialogs)verto.dialogs[i].hangup()},$.verto.prototype.newCall=function(args,callbacks){var verto=this;if(!verto.rpcClient.socketReady())return void console.error("Not Connected...");var dialog=new $.verto.dialog($.verto.enum.direction.outbound,this,args);return dialog.invite(),callbacks&&(dialog.callbacks=callbacks),dialog},$.verto.prototype.handleMessage=function(data){var verto=this;if(!data||!data.method)return void console.error("Invalid Data",data);if(data.params.callID){var dialog=verto.dialogs[data.params.callID];if("verto.attach"===data.method&&dialog&&(delete dialog.verto.dialogs[dialog.callID],dialog.rtc.stop(),dialog=null),dialog)switch(data.method){case"verto.bye":dialog.hangup(data.params);break;case"verto.answer":dialog.handleAnswer(data.params);break;case"verto.media":dialog.handleMedia(data.params);break;case"verto.display":dialog.handleDisplay(data.params);break;case"verto.info":dialog.handleInfo(data.params);break;default:console.debug("INVALID METHOD OR NON-EXISTANT CALL REFERENCE IGNORED",dialog,data.method)}else switch(data.method){case"verto.attach":data.params.attach=!0,data.params.sdp&&data.params.sdp.indexOf("m=video")>0&&(data.params.useVideo=!0),data.params.sdp&&data.params.sdp.indexOf("stereo=1")>0&&(data.params.useStereo=!0),dialog=new $.verto.dialog($.verto.enum.direction.inbound,verto,data.params),dialog.setState($.verto.enum.state.recovering);break;case"verto.invite":data.params.sdp&&data.params.sdp.indexOf("m=video")>0&&(data.params.wantVideo=!0),data.params.sdp&&data.params.sdp.indexOf("stereo=1")>0&&(data.params.useStereo=!0),dialog=new $.verto.dialog($.verto.enum.direction.inbound,verto,data.params);break;default:console.debug("INVALID METHOD OR NON-EXISTANT CALL REFERENCE IGNORED")}return{method:data.method}}switch(data.method){case"verto.punt":verto.purge(),verto.logout();break;case"verto.event":var list=null,key=null;if(data.params&&(key=data.params.eventChannel),key&&(list=verto.eventSUBS[key],list||(list=verto.eventSUBS[key.split(".")[0]])),!list&&key&&key===verto.sessid)verto.callbacks.onMessage&&verto.callbacks.onMessage(verto,null,$.verto.enum.message.pvtEvent,data.params);else if(!list&&key&&verto.dialogs[key])verto.dialogs[key].sendMessage($.verto.enum.message.pvtEvent,data.params);else if(list)for(var i in list){var sub=list[i];sub&&sub.ready?sub.handler?sub.handler(verto,data.params,sub.userData):verto.callbacks.onEvent?verto.callbacks.onEvent(verto,data.params,sub.userData):console.log("EVENT:",data.params):console.error("invalid EVENT for "+key+" IGNORED")}else key||(key="UNDEFINED"),console.error("UNSUBBED or invalid EVENT "+key+" IGNORED");break;case"verto.info":verto.callbacks.onMessage&&verto.callbacks.onMessage(verto,null,$.verto.enum.message.info,data.params.msg),console.debug("MESSAGE from: "+data.params.msg.from,data.params.msg.body);break;default:console.error("INVALID METHOD OR NON-EXISTANT CALL REFERENCE IGNORED",data.method)}};var del_array=function(array,name){for(var r=[],len=array.length,i=0;i<len;i++)array[i]!=name&&r.push(array[i]);return r},hashArray=function(){var vha=this,hash={},array=[];vha.reorder=function(a){array=a;var h=hash;hash={};for(var len=array.length,i=0;i<len;i++){var key=array[i];h[key]&&(hash[key]=h[key],delete h[key])}h=void 0},vha.clear=function(){hash=void 0,array=void 0,hash={},array=[]},vha.add=function(name,val,insertAt){var redraw=!1;if(!hash[name])if(void 0===insertAt||insertAt<0||insertAt>=array.length)array.push(name);else{for(var x=0,n=[],len=array.length,i=0;i<len;i++)x++==insertAt&&n.push(name),n.push(array[i]);array=void 0,array=n,n=void 0,redraw=!0}return hash[name]=val,redraw},vha.del=function(name){var r=!1;return hash[name]?(array=del_array(array,name),delete hash[name],r=!0):console.error("can't del nonexistant key "+name),r},vha.get=function(name){return hash[name]},vha.order=function(){return array},vha.hash=function(){return hash},vha.indexOf=function(name){for(var len=array.length,i=0;i<len;i++)if(array[i]==name)return i},vha.arrayLen=function(){return array.length},vha.asArray=function(){for(var r=[],len=array.length,i=0;i<len;i++){var key=array[i];r.push(hash[key])}return r},vha.each=function(cb){for(var len=array.length,i=0;i<len;i++)cb(array[i],hash[array[i]])},vha.dump=function(html){var str="";return vha.each(function(name,val){str+="name: "+name+" val: "+JSON.stringify(val)+(html?"<br>":"\n")}),str}};$.verto.liveArray=function(verto,context,name,config){var la=this,lastSerno=0,binding=null,user_obj=config.userObj;hashArray.call(la),la._add=la.add,la._del=la.del,la._reorder=la.reorder,la._clear=la.clear,la.context=context,la.name=name,la.user_obj=user_obj,la.verto=verto,la.broadcast=function(channel,obj){verto.broadcast(channel,obj)},la.errs=0,la.clear=function(){la._clear(),lastSerno=0,la.onChange&&la.onChange(la,{action:"clear"})},la.checkSerno=function(serno){return serno<0||(lastSerno>0&&serno!=lastSerno+1?(la.onErr&&la.onErr(la,{lastSerno:lastSerno,serno:serno}),la.errs++,console.debug(la.errs),la.errs<3&&la.bootstrap(la.user_obj),!1):(lastSerno=serno,!0))},la.reorder=function(serno,a){la.checkSerno(serno)&&(la._reorder(a),la.onChange&&la.onChange(la,{serno:serno,action:"reorder"}))},la.init=function(serno,val,key,index){null!==key&&void 0!==key||(key=serno),la.checkSerno(serno)&&la.onChange&&la.onChange(la,{serno:serno,action:"init",index:index,key:key,data:val})},la.bootObj=function(serno,val){if(la.checkSerno(serno)){for(var i in val)la._add(val[i][0],val[i][1]);la.onChange&&la.onChange(la,{serno:serno,action:"bootObj",data:val,redraw:!0})}},la.add=function(serno,val,key,index){if(null!==key&&void 0!==key||(key=serno),la.checkSerno(serno)){var redraw=la._add(key,val,index);la.onChange&&la.onChange(la,{serno:serno,action:"add",index:index,key:key,data:val,redraw:redraw})}},la.modify=function(serno,val,key,index){null!==key&&void 0!==key||(key=serno),la.checkSerno(serno)&&(la._add(key,val,index),la.onChange&&la.onChange(la,{serno:serno,action:"modify",key:key,data:val,index:index}))},la.del=function(serno,key,index){if(null!==key&&void 0!==key||(key=serno),la.checkSerno(serno)){(null===index||index<0||void 0===index)&&(index=la.indexOf(key));var ok=la._del(key);ok&&la.onChange&&la.onChange(la,{serno:serno,action:"del",key:key,index:index})}};var eventHandler=function(v,e,la){var packet=e.data;if(packet.name==la.name)switch(packet.action){case"init":la.init(packet.wireSerno,packet.data,packet.hashKey,packet.arrIndex);break;case"bootObj":la.bootObj(packet.wireSerno,packet.data);break;case"add":la.add(packet.wireSerno,packet.data,packet.hashKey,packet.arrIndex);break;case"modify":packet.arrIndex||packet.hashKey?la.modify(packet.wireSerno,packet.data,packet.hashKey,packet.arrIndex):console.error("Invalid Packet",packet);break;case"del":packet.arrIndex||packet.hashKey?la.del(packet.wireSerno,packet.hashKey,packet.arrIndex):console.error("Invalid Packet",packet);break;case"clear":la.clear();break;case"reorder":la.reorder(packet.wireSerno,packet.order);break;default:la.checkSerno(packet.wireSerno)&&la.onChange&&la.onChange(la,{serno:packet.wireSerno,action:packet.action,data:packet.data})}};la.context&&(binding=la.verto.subscribe(la.context,{handler:eventHandler,userData:la,subParams:config.subParams})),la.destroy=function(){la._clear(),la.verto.unsubscribe(binding)},la.sendCommand=function(cmd,obj){var self=la;self.broadcast(self.context,{liveArray:{command:cmd,context:self.context,name:self.name,obj:obj}})},la.bootstrap=function(obj){la.sendCommand("bootstrap",obj)},la.changepage=function(obj){var self=la;self.clear(),self.broadcast(self.context,{liveArray:{command:"changepage",context:la.context,name:la.name,obj:obj}})},la.heartbeat=function(obj){var self=la,callback=function(){self.heartbeat.call(self,obj)};self.broadcast(self.context,{liveArray:{command:"heartbeat",context:self.context,name:self.name,obj:obj}}),self.hb_pid=setTimeout(callback,3e4)},la.bootstrap(la.user_obj)},$.verto.liveTable=function(verto,context,name,jq,config){function genRow(data){if("string"==typeof data[4]&&data[4].indexOf("{")>-1){var tmp=$.parseJSON(data[4]);data[4]=tmp.oldStatus,data[5]=null}return data}function genArray(obj){var data=obj.asArray();for(var i in data)data[i]=genRow(data[i]);return data}var dt,la=new $.verto.liveArray(verto,context,name,{subParams:config.subParams}),lt=this;lt.liveArray=la,lt.dataTable=dt,lt.verto=verto,lt.destroy=function(){dt&&dt.fnDestroy(),la&&la.destroy(),dt=null,la=null},la.onErr=function(obj,args){console.error("Error: ",obj,args)},la.onChange=function(obj,args){var index=0,iserr=0;if(!dt){if(!config.aoColumns){if("init"!=args.action)return;config.aoColumns=[];for(var i in args.data)config.aoColumns.push({sTitle:args.data[i]})}dt=jq.dataTable(config)}if(dt&&("del"==args.action||"modify"==args.action)&&(index=args.index,void 0===index&&args.key&&(index=la.indexOf(args.key)),void 0===index))return void console.error("INVALID PACKET Missing INDEX\n",args);config.onChange&&config.onChange(obj,args);try{switch(args.action){case"bootObj":if(!args.data)return void console.error("missing data");dt.fnClearTable(),dt.fnAddData(genArray(obj)),dt.fnAdjustColumnSizing();break;case"add":if(!args.data)return void console.error("missing data");args.redraw>-1?(dt.fnClearTable(),dt.fnAddData(genArray(obj))):dt.fnAddData(genRow(args.data)),dt.fnAdjustColumnSizing();break;case"modify":if(!args.data)return;dt.fnUpdate(genRow(args.data),index),dt.fnAdjustColumnSizing();break;case"del":dt.fnDeleteRow(index),dt.fnAdjustColumnSizing();break;case"clear":dt.fnClearTable();break;case"reorder":dt.fnClearTable(),dt.fnAddData(genArray(obj));break;case"hide":jq.hide();break;case"show":jq.show()}}catch(err){console.error("ERROR: "+err),iserr++}iserr?(obj.errs++,obj.errs<3&&obj.bootstrap(obj.user_obj)):obj.errs=0},la.onChange(la,{action:"init"})};var CONFMAN_SERNO=1;$.verto.conf=function(verto,params){var conf=this;conf.params=$.extend({dialog:null,hasVid:!1,laData:null,onBroadcast:null,onLaChange:null,onLaRow:null},params),conf.verto=verto,conf.serno=CONFMAN_SERNO++,createMainModeratorMethods(),verto.subscribe(conf.params.laData.modChannel,{handler:function(v,e){conf.params.onBroadcast&&conf.params.onBroadcast(verto,conf,e.data)}}),verto.subscribe(conf.params.laData.chatChannel,{handler:function(v,e){"function"==typeof conf.params.chatCallback&&conf.params.chatCallback(v,e)}})},$.verto.conf.prototype.modCommand=function(cmd,id,value){var conf=this;conf.verto.rpcClient.call("verto.broadcast",{eventChannel:conf.params.laData.modChannel,data:{application:"conf-control",command:cmd,id:id,value:value}})},$.verto.conf.prototype.destroy=function(){var conf=this;conf.destroyed=!0,conf.params.onBroadcast(conf.verto,conf,"destroy"),conf.params.laData.modChannel&&conf.verto.unsubscribe(conf.params.laData.modChannel),conf.params.laData.chatChannel&&conf.verto.unsubscribe(conf.params.laData.chatChannel)},$.verto.modfuncs={},$.verto.confMan=function(verto,params){function genMainMod(jq){var play_id="play_"+confMan.serno,stop_id="stop_"+confMan.serno,recording_id="recording_"+confMan.serno,snapshot_id="snapshot_"+confMan.serno,rec_stop_id="recording_stop"+confMan.serno,div_id="confman_"+confMan.serno,html="<div id='"+div_id+"'><br><button class='ctlbtn' id='"+play_id+"'>Play</button><button class='ctlbtn' id='"+stop_id+"'>Stop</button><button class='ctlbtn' id='"+recording_id+"'>Record</button><button class='ctlbtn' id='"+rec_stop_id+"'>Record Stop</button>"+(confMan.params.hasVid?"<button class='ctlbtn' id='"+snapshot_id+"'>PNG Snapshot</button>":"")+"<br><br></div>";if(jq.html(html),$.verto.modfuncs.change_video_layout=function(id,canvas_id){var val=$("#"+id+" option:selected").text();"none"!==val&&confMan.modCommand("vid-layout",null,[val,canvas_id])},confMan.params.hasVid){for(var j=0;j<confMan.canvasCount;j++){var vlayout_id="confman_vid_layout_"+j+"_"+confMan.serno,vlselect_id="confman_vl_select_"+j+"_"+confMan.serno,vlhtml="<div id='"+vlayout_id+"'><br><b>Video Layout Canvas "+(j+1)+"</b> <select onChange='$.verto.modfuncs.change_video_layout(\""+vlayout_id+'", "'+(j+1)+"\")' id='"+vlselect_id+"'></select> <br><br></div>";jq.append(vlhtml)}$("#"+snapshot_id).click(function(){var file=prompt("Please enter file name","");file&&confMan.modCommand("vid-write-png",null,file)})}$("#"+play_id).click(function(){var file=prompt("Please enter file name","");file&&confMan.modCommand("play",null,file)}),$("#"+stop_id).click(function(){confMan.modCommand("stop",null,"all")}),$("#"+recording_id).click(function(){var file=prompt("Please enter file name","");file&&confMan.modCommand("recording",null,["start",file])}),$("#"+rec_stop_id).click(function(){confMan.modCommand("recording",null,["stop","all"])})}function genControls(jq,rowid){var x=parseInt(rowid),kick_id="kick_"+x,canvas_in_next_id="canvas_in_next_"+x,canvas_in_prev_id="canvas_in_prev_"+x,canvas_out_next_id="canvas_out_next_"+x,canvas_out_prev_id="canvas_out_prev_"+x,canvas_in_set_id="canvas_in_set_"+x,canvas_out_set_id="canvas_out_set_"+x,layer_set_id="layer_set_"+x,layer_next_id="layer_next_"+x,layer_prev_id="layer_prev_"+x,tmute_id="tmute_"+x,tvmute_id="tvmute_"+x,vbanner_id="vbanner_"+x,tvpresenter_id="tvpresenter_"+x,tvfloor_id="tvfloor_"+x,box_id="box_"+x,gainup_id="gain_in_up"+x,gaindn_id="gain_in_dn"+x,volup_id="vol_in_up"+x,voldn_id="vol_in_dn"+x,transfer_id="transfer"+x,html="<div id='"+box_id+"'>";return html+="<b>General Controls</b><hr noshade>",html+="<button class='ctlbtn' id='"+kick_id+"'>Kick</button><button class='ctlbtn' id='"+tmute_id+"'>Mute</button><button class='ctlbtn' id='"+gainup_id+"'>Gain -</button><button class='ctlbtn' id='"+gaindn_id+"'>Gain +</button><button class='ctlbtn' id='"+voldn_id+"'>Vol -</button><button class='ctlbtn' id='"+volup_id+"'>Vol +</button><button class='ctlbtn' id='"+transfer_id+"'>Transfer</button>",confMan.params.hasVid&&(html+="<br><br><b>Video Controls</b><hr noshade>",html+="<button class='ctlbtn' id='"+tvmute_id+"'>VMute</button><button class='ctlbtn' id='"+tvpresenter_id+"'>Presenter</button><button class='ctlbtn' id='"+tvfloor_id+"'>Vid Floor</button><button class='ctlbtn' id='"+vbanner_id+"'>Banner</button>",confMan.canvasCount>1&&(html+="<br><br><b>Canvas Controls</b><hr noshade><button class='ctlbtn' id='"+canvas_in_set_id+"'>Set Input Canvas</button><button class='ctlbtn' id='"+canvas_in_prev_id+"'>Prev Input Canvas</button><button class='ctlbtn' id='"+canvas_in_next_id+"'>Next Input Canvas</button><br><button class='ctlbtn' id='"+canvas_out_set_id+"'>Set Watching Canvas</button><button class='ctlbtn' id='"+canvas_out_prev_id+"'>Prev Watching Canvas</button><button class='ctlbtn' id='"+canvas_out_next_id+"'>Next Watching Canvas</button>"),html+="<br><button class='ctlbtn' id='"+layer_set_id+"'>Set Layer</button><button class='ctlbtn' id='"+layer_prev_id+"'>Prev Layer</button><button class='ctlbtn' id='"+layer_next_id+"'>Next Layer</button></div>"),jq.html(html),jq.data("mouse")||$("#"+box_id).hide(),jq.mouseover(function(e){jq.data({mouse:!0}),$("#"+box_id).show()}),jq.mouseout(function(e){jq.data({mouse:!1}),$("#"+box_id).hide()}),$("#"+transfer_id).click(function(){var xten=prompt("Enter Extension");xten&&confMan.modCommand("transfer",x,xten)}),$("#"+kick_id).click(function(){confMan.modCommand("kick",x)}),$("#"+layer_set_id).click(function(){var cid=prompt("Please enter layer ID","");cid&&confMan.modCommand("vid-layer",x,cid)}),$("#"+layer_next_id).click(function(){confMan.modCommand("vid-layer",x,"next")}),$("#"+layer_prev_id).click(function(){confMan.modCommand("vid-layer",x,"prev")}),$("#"+canvas_in_set_id).click(function(){var cid=prompt("Please enter canvas ID","");cid&&confMan.modCommand("vid-canvas",x,cid)}),$("#"+canvas_out_set_id).click(function(){var cid=prompt("Please enter canvas ID","");cid&&confMan.modCommand("vid-watching-canvas",x,cid)}),$("#"+canvas_in_next_id).click(function(){confMan.modCommand("vid-canvas",x,"next")}),$("#"+canvas_in_prev_id).click(function(){confMan.modCommand("vid-canvas",x,"prev")}),$("#"+canvas_out_next_id).click(function(){confMan.modCommand("vid-watching-canvas",x,"next")}),$("#"+canvas_out_prev_id).click(function(){confMan.modCommand("vid-watching-canvas",x,"prev")}),$("#"+tmute_id).click(function(){confMan.modCommand("tmute",x)}),confMan.params.hasVid&&($("#"+tvmute_id).click(function(){confMan.modCommand("tvmute",x)}),$("#"+tvpresenter_id).click(function(){confMan.modCommand("vid-res-id",x,"presenter")}),$("#"+tvfloor_id).click(function(){confMan.modCommand("vid-floor",x,"force")}),$("#"+vbanner_id).click(function(){var text=prompt("Please enter text","");text&&confMan.modCommand("vid-banner",x,escape(text))})),$("#"+gainup_id).click(function(){confMan.modCommand("volume_in",x,"up")}),$("#"+gaindn_id).click(function(){confMan.modCommand("volume_in",x,"down")}),$("#"+volup_id).click(function(){confMan.modCommand("volume_out",x,"up")}),$("#"+voldn_id).click(function(){confMan.modCommand("volume_out",x,"down")}),html}var confMan=this;confMan.params=$.extend({tableID:null,statusID:null,mainModID:null,dialog:null,hasVid:!1,laData:null,onBroadcast:null,onLaChange:null,onLaRow:null},params),confMan.verto=verto,confMan.serno=CONFMAN_SERNO++,confMan.canvasCount=confMan.params.laData.canvasCount;var atitle="",awidth=0;verto.subscribe(confMan.params.laData.chatChannel,{handler:function(v,e){"function"==typeof confMan.params.chatCallback&&confMan.params.chatCallback(v,e)}}),"moderator"===confMan.params.laData.role&&(atitle="Action",awidth=600,confMan.params.mainModID?(genMainMod($(confMan.params.mainModID)),$(confMan.params.displayID).html("Moderator Controls Ready<br><br>")):$(confMan.params.mainModID).html(""),verto.subscribe(confMan.params.laData.modChannel,{handler:function(v,e){if(confMan.params.onBroadcast&&confMan.params.onBroadcast(verto,confMan,e.data),"list-videoLayouts"===e.data["conf-command"])for(var j=0;j<confMan.canvasCount;j++){var options,vlselect_id="#confman_vl_select_"+j+"_"+confMan.serno,vlayout_id="#confman_vid_layout_"+j+"_"+confMan.serno,x=0;if($(vlselect_id).selectmenu({}),$(vlselect_id).selectmenu("enable"),$(vlselect_id).empty(),$(vlselect_id).append(new Option("Choose a Layout","none")),e.data.responseData){var rdata=[];for(var i in e.data.responseData)rdata.push(e.data.responseData[i].name);options=rdata.sort(function(a,b){var ga="group:"==a.substring(0,6),gb="group:"==b.substring(0,6);return(ga||gb)&&ga!=gb?ga?-1:1:a==b?0:a>b?1:-1});for(var i in options)$(vlselect_id).append(new Option(options[i],options[i])),x++}x?$(vlselect_id).selectmenu("refresh",!0):$(vlayout_id).hide()}else!confMan.destroyed&&confMan.params.displayID&&($(confMan.params.displayID).html(e.data.response+"<br><br>"),confMan.lastTimeout&&(clearTimeout(confMan.lastTimeout),confMan.lastTimeout=0),confMan.lastTimeout=setTimeout(function(){$(confMan.params.displayID).html(confMan.destroyed?"":"Moderator Controls Ready<br><br>")},4e3))}}),confMan.params.hasVid&&confMan.modCommand("list-videoLayouts",null,null));var row_callback=null;"moderator"===confMan.params.laData.role&&(row_callback=function(nRow,aData,iDisplayIndex,iDisplayIndexFull){if(!aData[5]){var $row=$("td:eq(5)",nRow);genControls($row,aData),confMan.params.onLaRow&&confMan.params.onLaRow(verto,confMan,$row,aData)}}),confMan.lt=new $.verto.liveTable(verto,confMan.params.laData.laChannel,confMan.params.laData.laName,$(confMan.params.tableID),{subParams:{callID:confMan.params.dialog?confMan.params.dialog.callID:null},onChange:function(obj,args){$(confMan.params.statusID).text("Conference Members:  ("+obj.arrayLen()+" Total)"),confMan.params.onLaChange&&confMan.params.onLaChange(verto,confMan,$.verto.enum.confEvent.laChange,obj,args)},aaData:[],aoColumns:[{sTitle:"ID",sWidth:"50"},{sTitle:"Number",sWidth:"250"},{sTitle:"Name",sWidth:"250"},{sTitle:"Codec",sWidth:"100"},{sTitle:"Status",sWidth:confMan.params.hasVid?"200px":"150px"},{sTitle:atitle,sWidth:awidth}],bAutoWidth:!0,bDestroy:!0,bSort:!1,bInfo:!1,bFilter:!1,bLengthChange:!1,bPaginate:!1,iDisplayLength:1400,oLanguage:{sEmptyTable:"The Conference is Empty....."},fnRowCallback:row_callback})},$.verto.confMan.prototype.modCommand=function(cmd,id,value){var confMan=this;confMan.verto.rpcClient.call("verto.broadcast",{eventChannel:confMan.params.laData.modChannel,data:{application:"conf-control",command:cmd,id:id,value:value}})},$.verto.confMan.prototype.sendChat=function(message,type){var confMan=this;confMan.verto.rpcClient.call("verto.broadcast",{eventChannel:confMan.params.laData.chatChannel,data:{action:"send",message:message,type:type}})},$.verto.confMan.prototype.destroy=function(){var confMan=this;confMan.destroyed=!0,confMan.lt&&confMan.lt.destroy(),confMan.params.laData.chatChannel&&confMan.verto.unsubscribe(confMan.params.laData.chatChannel),confMan.params.laData.modChannel&&confMan.verto.unsubscribe(confMan.params.laData.modChannel),confMan.params.mainModID&&$(confMan.params.mainModID).html("")},$.verto.dialog=function(direction,verto,params){var dialog=this,tag=verto.options.tag;"function"==typeof tag&&(tag=tag()),dialog.params=$.extend({useVideo:verto.options.useVideo,useStereo:verto.options.useStereo,screenShare:!1,useCamera:verto.options.deviceParams.useCamera,useMic:verto.options.deviceParams.useMic,useSpeak:verto.options.deviceParams.useSpeak,tag:tag,localTag:verto.options.localTag,login:verto.options.login,videoParams:verto.options.videoParams},params),dialog.verto=verto,dialog.direction=direction,dialog.lastState=null,dialog.state=dialog.lastState=$.verto.enum.state.new,dialog.callbacks=verto.callbacks,dialog.answered=!1,dialog.attach=params.attach||!1,dialog.screenShare=params.screenShare||!1,dialog.useCamera=dialog.params.useCamera,dialog.useMic=dialog.params.useMic,dialog.useSpeak=dialog.params.useSpeak,dialog.params.callID?dialog.callID=dialog.params.callID:dialog.callID=dialog.params.callID=generateGUID(),dialog.params.tag&&(dialog.audioStream=document.getElementById(dialog.params.tag),dialog.params.useVideo&&(dialog.videoStream=dialog.audioStream)),dialog.params.localTag&&(dialog.localVideo=document.getElementById(dialog.params.localTag)),dialog.verto.dialogs[dialog.callID]=dialog;var RTCcallbacks={};dialog.direction==$.verto.enum.direction.inbound?("outbound"===dialog.params.display_direction?(dialog.params.remote_caller_id_name=dialog.params.caller_id_name,dialog.params.remote_caller_id_number=dialog.params.caller_id_number):(dialog.params.remote_caller_id_name=dialog.params.callee_id_name,dialog.params.remote_caller_id_number=dialog.params.callee_id_number),dialog.params.remote_caller_id_name||(dialog.params.remote_caller_id_name="Nobody"),dialog.params.remote_caller_id_number||(dialog.params.remote_caller_id_number="UNKNOWN"),RTCcallbacks.onMessage=function(rtc,msg){console.debug(msg)},RTCcallbacks.onAnswerSDP=function(rtc,sdp){console.error("answer sdp",sdp)}):(dialog.params.remote_caller_id_name="Outbound Call",dialog.params.remote_caller_id_number=dialog.params.destination_number),RTCcallbacks.onICESDP=function(rtc){return console.log("RECV "+rtc.type+" SDP",rtc.mediaData.SDP),dialog.state==$.verto.enum.state.requesting||dialog.state==$.verto.enum.state.answering||dialog.state==$.verto.enum.state.active?void location.reload():void("offer"==rtc.type?dialog.state==$.verto.enum.state.active?(dialog.setState($.verto.enum.state.requesting),dialog.sendMethod("verto.attach",{sdp:rtc.mediaData.SDP})):(dialog.setState($.verto.enum.state.requesting),dialog.sendMethod("verto.invite",{sdp:rtc.mediaData.SDP})):(dialog.setState($.verto.enum.state.answering),dialog.sendMethod(dialog.attach?"verto.attach":"verto.answer",{sdp:dialog.rtc.mediaData.SDP})))},RTCcallbacks.onICE=function(rtc){"offer"==rtc.type&&console.log("offer",rtc.mediaData.candidate)},RTCcallbacks.onStream=function(rtc,stream){dialog.verto.options.permissionCallback&&"function"==typeof dialog.verto.options.permissionCallback.onGranted&&dialog.verto.options.permissionCallback.onGranted(),console.log("stream started")},RTCcallbacks.onError=function(e){dialog.verto.options.permissionCallback&&"function"==typeof dialog.verto.options.permissionCallback.onDenied&&dialog.verto.options.permissionCallback.onDenied(),console.error("ERROR:",e),dialog.hangup({cause:"Device or Permission Error"})},dialog.rtc=new $.FSRTC({callbacks:RTCcallbacks,localVideo:dialog.screenShare?null:dialog.localVideo,useVideo:dialog.params.useVideo?dialog.videoStream:null,useAudio:dialog.audioStream,useStereo:dialog.params.useStereo,videoParams:dialog.params.videoParams,audioParams:verto.options.audioParams,iceServers:verto.options.iceServers,screenShare:dialog.screenShare,useCamera:dialog.useCamera,useMic:dialog.useMic,useSpeak:dialog.useSpeak}),dialog.rtc.verto=dialog.verto,dialog.direction==$.verto.enum.direction.inbound&&(dialog.attach?dialog.answer():dialog.ring())},$.verto.dialog.prototype.invite=function(){var dialog=this;dialog.rtc.call()},$.verto.dialog.prototype.sendMethod=function(method,obj){var dialog=this;obj.dialogParams={};for(var i in dialog.params)"sdp"==i&&"verto.invite"!=method&&"verto.attach"!=method||(obj.dialogParams[i]=dialog.params[i]);dialog.verto.rpcClient.call(method,obj,function(e){dialog.processReply(method,!0,e)},function(e){dialog.processReply(method,!1,e)})},$.verto.dialog.prototype.setAudioPlaybackDevice=function(sinkId,callback,arg){var dialog=this,element=dialog.audioStream;if("undefined"!=typeof element.sinkId){var devname=find_name(sinkId);console.info("Dialog: "+dialog.callID+" Setting speaker:",element,devname),element.setSinkId(sinkId).then(function(){console.log("Dialog: "+dialog.callID+" Success, audio output device attached: "+sinkId),callback&&callback(!0,devname,arg)}).catch(function(error){var errorMessage=error;"SecurityError"===error.name&&(errorMessage="Dialog: "+dialog.callID+" You need to use HTTPS for selecting audio output device: "+error),callback&&callback(!1,null,arg),console.error(errorMessage)})}else console.warn("Dialog: "+dialog.callID+" Browser does not support output device selection."),callback&&callback(!1,null,arg)},$.verto.dialog.prototype.setState=function(state){var dialog=this;if(dialog.state==$.verto.enum.state.ringing&&dialog.stopRinging(),dialog.state==state||!checkStateChange(dialog.state,state))return console.error("Dialog "+dialog.callID+": INVALID state change from "+dialog.state.name+" to "+state.name),dialog.hangup(),!1;switch(console.log("Dialog "+dialog.callID+": state change from "+dialog.state.name+" to "+state.name),dialog.lastState=dialog.state,dialog.state=state,dialog.causeCode||(dialog.causeCode=16),dialog.cause||(dialog.cause="NORMAL CLEARING"),dialog.callbacks.onDialogState&&dialog.callbacks.onDialogState(this),dialog.state){case $.verto.enum.state.early:case $.verto.enum.state.active:
var speaker=dialog.useSpeak;console.info("Using Speaker: ",speaker),speaker&&"any"!==speaker&&"none"!==speaker&&setTimeout(function(){dialog.setAudioPlaybackDevice(speaker)},500);break;case $.verto.enum.state.trying:setTimeout(function(){dialog.state==$.verto.enum.state.trying&&dialog.setState($.verto.enum.state.hangup)},3e4);break;case $.verto.enum.state.purge:dialog.setState($.verto.enum.state.destroy);break;case $.verto.enum.state.hangup:dialog.lastState.val>$.verto.enum.state.requesting.val&&dialog.lastState.val<$.verto.enum.state.hangup.val&&dialog.sendMethod("verto.bye",{}),dialog.setState($.verto.enum.state.destroy);break;case $.verto.enum.state.destroy:"function"==typeof dialog.verto.options.tag&&$("#"+dialog.params.tag).remove(),delete dialog.verto.dialogs[dialog.callID],dialog.params.screenShare?dialog.rtc.stopPeer():dialog.rtc.stop()}return!0},$.verto.dialog.prototype.processReply=function(method,success,e){var dialog=this;switch(method){case"verto.answer":case"verto.attach":success?dialog.setState($.verto.enum.state.active):dialog.hangup();break;case"verto.invite":success?dialog.setState($.verto.enum.state.trying):dialog.setState($.verto.enum.state.destroy);break;case"verto.bye":dialog.hangup();break;case"verto.modify":e.holdState&&("held"==e.holdState?dialog.state!=$.verto.enum.state.held&&dialog.setState($.verto.enum.state.held):"active"==e.holdState&&dialog.state!=$.verto.enum.state.active&&dialog.setState($.verto.enum.state.active))}},$.verto.dialog.prototype.hangup=function(params){var dialog=this;params&&(params.causeCode&&(dialog.causeCode=params.causeCode),params.cause&&(dialog.cause=params.cause)),dialog.state.val>=$.verto.enum.state.new.val&&dialog.state.val<$.verto.enum.state.hangup.val?dialog.setState($.verto.enum.state.hangup):dialog.state.val<$.verto.enum.state.destroy&&dialog.setState($.verto.enum.state.destroy)},$.verto.dialog.prototype.stopRinging=function(){var dialog=this;dialog.verto.ringer&&dialog.verto.ringer.stop()},$.verto.dialog.prototype.indicateRing=function(){var dialog=this;dialog.verto.ringer&&(dialog.verto.ringer.attr("src",dialog.verto.options.ringFile)[0].play(),setTimeout(function(){dialog.stopRinging(),dialog.state==$.verto.enum.state.ringing&&dialog.indicateRing()},dialog.verto.options.ringSleep))},$.verto.dialog.prototype.ring=function(){var dialog=this;dialog.setState($.verto.enum.state.ringing),dialog.indicateRing()},$.verto.dialog.prototype.useVideo=function(on){var dialog=this;dialog.params.useVideo=on,on?dialog.videoStream=dialog.audioStream:dialog.videoStream=null,dialog.rtc.useVideo(dialog.videoStream,dialog.localVideo)},$.verto.dialog.prototype.setMute=function(what){var dialog=this;return dialog.rtc.setMute(what)},$.verto.dialog.prototype.getMute=function(){var dialog=this;return dialog.rtc.getMute()},$.verto.dialog.prototype.setVideoMute=function(what){var dialog=this;return dialog.rtc.setVideoMute(what)},$.verto.dialog.prototype.getVideoMute=function(){var dialog=this;return dialog.rtc.getVideoMute()},$.verto.dialog.prototype.useStereo=function(on){var dialog=this;dialog.params.useStereo=on,dialog.rtc.useStereo(on)},$.verto.dialog.prototype.dtmf=function(digits){var dialog=this;digits&&dialog.sendMethod("verto.info",{dtmf:digits})},$.verto.dialog.prototype.transfer=function(dest,params){var dialog=this;dest&&dialog.sendMethod("verto.modify",{action:"transfer",destination:dest,params:params})},$.verto.dialog.prototype.hold=function(params){var dialog=this;dialog.sendMethod("verto.modify",{action:"hold",params:params})},$.verto.dialog.prototype.unhold=function(params){var dialog=this;dialog.sendMethod("verto.modify",{action:"unhold",params:params})},$.verto.dialog.prototype.toggleHold=function(params){var dialog=this;dialog.sendMethod("verto.modify",{action:"toggleHold",params:params})},$.verto.dialog.prototype.message=function(msg){var dialog=this,err=0;return msg.from=dialog.params.login,msg.to||(console.error("Missing To"),err++),msg.body||(console.error("Missing Body"),err++),!err&&(dialog.sendMethod("verto.info",{msg:msg}),!0)},$.verto.dialog.prototype.answer=function(params){var dialog=this;dialog.answered||(params||(params={}),params.sdp=dialog.params.sdp,params&&(params.useVideo&&dialog.useVideo(!0),dialog.params.callee_id_name=params.callee_id_name,dialog.params.callee_id_number=params.callee_id_number,params.useCamera&&(dialog.useCamera=params.useCamera),params.useMic&&(dialog.useMic=params.useMic),params.useSpeak&&(dialog.useSpeak=params.useSpeak)),dialog.rtc.createAnswer(params),dialog.answered=!0)},$.verto.dialog.prototype.handleAnswer=function(params){var dialog=this;dialog.gotAnswer=!0,dialog.state.val>=$.verto.enum.state.active.val||(dialog.state.val>=$.verto.enum.state.early.val?dialog.setState($.verto.enum.state.active):dialog.gotEarly?console.log("Dialog "+dialog.callID+" Got answer while still establishing early media, delaying..."):(console.log("Dialog "+dialog.callID+" Answering Channel"),dialog.rtc.answer(params.sdp,function(){dialog.setState($.verto.enum.state.active)},function(e){console.error(e),dialog.hangup()}),console.log("Dialog "+dialog.callID+"ANSWER SDP",params.sdp)))},$.verto.dialog.prototype.cidString=function(enc){var dialog=this,party=dialog.params.remote_caller_id_name+(enc?" &lt;":" <")+dialog.params.remote_caller_id_number+(enc?"&gt;":">");return party},$.verto.dialog.prototype.sendMessage=function(msg,params){var dialog=this;dialog.callbacks.onMessage&&dialog.callbacks.onMessage(dialog.verto,dialog,msg,params)},$.verto.dialog.prototype.handleInfo=function(params){var dialog=this;dialog.sendMessage($.verto.enum.message.info,params.msg)},$.verto.dialog.prototype.handleDisplay=function(params){var dialog=this;params.display_name&&(dialog.params.remote_caller_id_name=params.display_name),params.display_number&&(dialog.params.remote_caller_id_number=params.display_number),dialog.sendMessage($.verto.enum.message.display,{})},$.verto.dialog.prototype.handleMedia=function(params){var dialog=this;dialog.state.val>=$.verto.enum.state.early.val||(dialog.gotEarly=!0,dialog.rtc.answer(params.sdp,function(){console.log("Dialog "+dialog.callID+"Establishing early media"),dialog.setState($.verto.enum.state.early),dialog.gotAnswer&&(console.log("Dialog "+dialog.callID+"Answering Channel"),dialog.setState($.verto.enum.state.active))},function(e){console.error(e),dialog.hangup()}),console.log("Dialog "+dialog.callID+"EARLY SDP",params.sdp))},$.verto.ENUM=function(s){var i=0,o={};return s.split(" ").map(function(x){o[x]={name:x,val:i++}}),Object.freeze(o)},$.verto.enum={},$.verto.enum.states=Object.freeze({new:{requesting:1,recovering:1,ringing:1,destroy:1,answering:1,hangup:1},requesting:{trying:1,hangup:1,active:1},recovering:{answering:1,hangup:1},trying:{active:1,early:1,hangup:1},ringing:{answering:1,hangup:1},answering:{active:1,hangup:1},active:{answering:1,requesting:1,hangup:1,held:1},held:{hangup:1,active:1},early:{hangup:1,active:1},hangup:{destroy:1},destroy:{},purge:{destroy:1}}),$.verto.enum.state=$.verto.ENUM("new requesting trying recovering ringing answering early active held hangup destroy purge"),$.verto.enum.direction=$.verto.ENUM("inbound outbound"),$.verto.enum.message=$.verto.ENUM("display info pvtEvent"),$.verto.enum=Object.freeze($.verto.enum),$.verto.saved=[],$.verto.unloadJobs=[],$(window).bind("beforeunload",function(){for(var f in $.verto.unloadJobs)$.verto.unloadJobs[f]();for(var i in $.verto.saved){var verto=$.verto.saved[i];verto&&(verto.purge(),verto.logout())}return $.verto.warnOnUnload}),$.verto.videoDevices=[],$.verto.audioInDevices=[],$.verto.audioOutDevices=[];var checkDevices=function(runtime){console.info("enumerating devices");var aud_in=[],aud_out=[],vid=[];if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices||!MediaStreamTrack.getSources){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return void console.log("enumerateDevices() not supported.");navigator.mediaDevices.enumerateDevices().then(function(devices){devices.forEach(function(device){console.log(device),console.log(device.kind+": "+device.label+" id = "+device.deviceId),"videoinput"===device.kind?vid.push({id:device.deviceId,kind:"video",label:device.label}):"audioinput"===device.kind?aud_in.push({id:device.deviceId,kind:"audio_in",label:device.label}):"audiooutput"===device.kind&&aud_out.push({id:device.deviceId,kind:"audio_out",label:device.label})}),$.verto.videoDevices=vid,$.verto.audioInDevices=aud_in,$.verto.audioOutDevices=aud_out,console.info("Audio IN Devices",$.verto.audioInDevices),console.info("Audio Out Devices",$.verto.audioOutDevices),console.info("Video Devices",$.verto.videoDevices),runtime(!0)}).catch(function(err){console.log(" Device Enumeration ERROR: "+err.name+": "+err.message),runtime(!1)})}else MediaStreamTrack.getSources(function(media_sources){for(var i=0;i<media_sources.length;i++)"video"==media_sources[i].kind?vid.push(media_sources[i]):aud_in.push(media_sources[i]);$.verto.videoDevices=vid,$.verto.audioInDevices=aud_in,console.info("Audio Devices",$.verto.audioInDevices),console.info("Video Devices",$.verto.videoDevices),runtime(!0)})};$.verto.refreshDevices=function(runtime){checkDevices(runtime)},$.verto.init=function(obj,runtime){obj||(obj={}),obj.skipPermCheck||obj.skipDeviceCheck?obj.skipPermCheck&&!obj.skipDeviceCheck?checkDevices(runtime):!obj.skipPermCheck&&obj.skipDeviceCheck?$.FSRTC.checkPerms(function(status){runtime(status)},!0,!0):runtime(null):$.FSRTC.checkPerms(function(status){checkDevices(runtime)},!0,!0)},$.verto.genUUID=function(){return generateGUID()}}(jQuery),!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a("object"==typeof exports?require("jquery"):jQuery)}(function($){"use strict";var escape=/["\\\x00-\x1f\x7f-\x9f]/g,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},hasOwn=Object.prototype.hasOwnProperty;$.toJSON="object"==typeof JSON&&JSON.stringify?JSON.stringify:function(a){if(null===a)return"null";var b,c,d,e,f=$.type(a);if("undefined"!==f){if("number"===f||"boolean"===f)return String(a);if("string"===f)return $.quoteString(a);if("function"==typeof a.toJSON)return $.toJSON(a.toJSON());if("date"===f){var g=a.getUTCMonth()+1,h=a.getUTCDate(),i=a.getUTCFullYear(),j=a.getUTCHours(),k=a.getUTCMinutes(),l=a.getUTCSeconds(),m=a.getUTCMilliseconds();return g<10&&(g="0"+g),h<10&&(h="0"+h),j<10&&(j="0"+j),k<10&&(k="0"+k),l<10&&(l="0"+l),m<100&&(m="0"+m),m<10&&(m="0"+m),'"'+i+"-"+g+"-"+h+"T"+j+":"+k+":"+l+"."+m+'Z"'}if(b=[],$.isArray(a)){for(c=0;c<a.length;c++)b.push($.toJSON(a[c])||"null");return"["+b.join(",")+"]"}if("object"==typeof a){for(c in a)if(hasOwn.call(a,c)){if(f=typeof c,"number"===f)d='"'+c+'"';else{if("string"!==f)continue;d=$.quoteString(c)}f=typeof a[c],"function"!==f&&"undefined"!==f&&(e=$.toJSON(a[c]),b.push(d+":"+e))}return"{"+b.join(",")+"}"}}},$.evalJSON="object"==typeof JSON&&JSON.parse?JSON.parse:function(str){return eval("("+str+")")},$.secureEvalJSON="object"==typeof JSON&&JSON.parse?JSON.parse:function(str){var filtered=str.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"");if(/^[\],:{}\s]*$/.test(filtered))return eval("("+str+")");throw new SyntaxError("Error parsing JSON, source is not valid.")},$.quoteString=function(a){return a.match(escape)?'"'+a.replace(escape,function(a){var b=meta[a];return"string"==typeof b?b:(b=a.charCodeAt(),"\\u00"+Math.floor(b/16).toString(16)+(b%16).toString(16))})+'"':'"'+a+'"'}}),function(){function getScreenConstraints(error,sourceId){var screen_constraints={audio:!1,video:{mandatory:{chromeMediaSource:error?"screen":"desktop",maxWidth:window.screen.width>1920?window.screen.width:1920,maxHeight:window.screen.height>1080?window.screen.height:1080},optional:[]}};return sourceId&&(screen_constraints.video.mandatory.chromeMediaSourceId=sourceId),screen_constraints}function postMessage(){return iframe?iframe.isLoaded?void iframe.contentWindow.postMessage({captureSourceId:!0},"*"):void setTimeout(postMessage,100):void loadIFrame(postMessage)}function loadIFrame(loadCallback){return iframe?void loadCallback():(iframe=document.createElement("iframe"),iframe.onload=function(){iframe.isLoaded=!0,loadCallback()},iframe.src="https://www.webrtc-experiment.com/getSourceId/",iframe.style.display="none",void(document.body||document.documentElement).appendChild(iframe))}window.getScreenId=function(callback){function onIFrameCallback(event){event.data&&(event.data.chromeMediaSourceId&&("PermissionDeniedError"===event.data.chromeMediaSourceId?callback("permission-denied"):callback(null,event.data.chromeMediaSourceId,getScreenConstraints(null,event.data.chromeMediaSourceId))),event.data.chromeExtensionStatus&&callback(event.data.chromeExtensionStatus,null,getScreenConstraints(event.data.chromeExtensionStatus)),window.removeEventListener("message",onIFrameCallback))}return navigator.mozGetUserMedia?void callback(null,"firefox",{video:{mozMediaSource:"window",mediaSource:"window"}}):(postMessage(),void window.addEventListener("message",onIFrameCallback))};var iframe;window.getScreenConstraints=function(callback){loadIFrame(function(){getScreenId(function(error,sourceId,screen_constraints){callback(error,screen_constraints.video)})})}}(),function(){function getScreenConstraints(error,sourceId){var screen_constraints={audio:!1,video:{mandatory:{chromeMediaSource:error?"screen":"desktop",maxWidth:window.screen.width>1920?window.screen.width:1920,maxHeight:window.screen.height>1080?window.screen.height:1080},optional:[]}};return sourceId&&(screen_constraints.video.mandatory.chromeMediaSourceId=sourceId),screen_constraints}function postMessage(){return iframe?iframe.isLoaded?void iframe.contentWindow.postMessage({captureSourceId:!0},"*"):void setTimeout(postMessage,100):void loadIFrame(postMessage)}function loadIFrame(loadCallback){return iframe?void loadCallback():(iframe=document.createElement("iframe"),iframe.onload=function(){iframe.isLoaded=!0,loadCallback()},iframe.src="https://www.webrtc-experiment.com/getSourceId/",iframe.style.display="none",void(document.body||document.documentElement).appendChild(iframe))}if(document.domain.indexOf("webrtc-experiment.com")!==-1){window.getScreenId=function(callback){function onIFrameCallback(event){event.data&&(event.data.chromeMediaSourceId&&("PermissionDeniedError"===event.data.chromeMediaSourceId?callback("permission-denied"):callback(null,event.data.chromeMediaSourceId,getScreenConstraints(null,event.data.chromeMediaSourceId))),event.data.chromeExtensionStatus&&callback(event.data.chromeExtensionStatus,null,getScreenConstraints(event.data.chromeExtensionStatus)),window.removeEventListener("message",onIFrameCallback))}return navigator.mozGetUserMedia?void callback(null,"firefox",{video:{mozMediaSource:"window",mediaSource:"window"}}):(postMessage(),void window.addEventListener("message",onIFrameCallback))};var iframe;window.getScreenConstraints=function(callback){loadIFrame(function(){getScreenId(function(error,sourceId,screen_constraints){callback(error,screen_constraints.video)})})}}}(),!function(a){"use strict";function b(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function c(a,b){return a<<b|a>>>32-b}function d(a,d,e,f,g,h){return b(c(b(b(d,a),b(f,h)),g),e)}function e(a,b,c,e,f,g,h){return d(b&c|~b&e,a,b,f,g,h)}function f(a,b,c,e,f,g,h){return d(b&e|c&~e,a,b,f,g,h)}function g(a,b,c,e,f,g,h){return d(b^c^e,a,b,f,g,h)}function h(a,b,c,e,f,g,h){return d(c^(b|~e),a,b,f,g,h)}function i(a,c){a[c>>5]|=128<<c%32,a[(c+64>>>9<<4)+14]=c;var d,i,j,k,l,m=1732584193,n=-271733879,o=-1732584194,p=271733878;for(d=0;d<a.length;d+=16)i=m,j=n,k=o,l=p,m=e(m,n,o,p,a[d],7,-680876936),p=e(p,m,n,o,a[d+1],12,-389564586),o=e(o,p,m,n,a[d+2],17,606105819),n=e(n,o,p,m,a[d+3],22,-1044525330),m=e(m,n,o,p,a[d+4],7,-176418897),p=e(p,m,n,o,a[d+5],12,1200080426),o=e(o,p,m,n,a[d+6],17,-1473231341),n=e(n,o,p,m,a[d+7],22,-45705983),m=e(m,n,o,p,a[d+8],7,1770035416),p=e(p,m,n,o,a[d+9],12,-1958414417),o=e(o,p,m,n,a[d+10],17,-42063),n=e(n,o,p,m,a[d+11],22,-1990404162),m=e(m,n,o,p,a[d+12],7,1804603682),p=e(p,m,n,o,a[d+13],12,-40341101),o=e(o,p,m,n,a[d+14],17,-1502002290),n=e(n,o,p,m,a[d+15],22,1236535329),m=f(m,n,o,p,a[d+1],5,-165796510),p=f(p,m,n,o,a[d+6],9,-1069501632),o=f(o,p,m,n,a[d+11],14,643717713),n=f(n,o,p,m,a[d],20,-373897302),m=f(m,n,o,p,a[d+5],5,-701558691),p=f(p,m,n,o,a[d+10],9,38016083),o=f(o,p,m,n,a[d+15],14,-660478335),n=f(n,o,p,m,a[d+4],20,-405537848),m=f(m,n,o,p,a[d+9],5,568446438),p=f(p,m,n,o,a[d+14],9,-1019803690),o=f(o,p,m,n,a[d+3],14,-187363961),n=f(n,o,p,m,a[d+8],20,1163531501),m=f(m,n,o,p,a[d+13],5,-1444681467),p=f(p,m,n,o,a[d+2],9,-51403784),o=f(o,p,m,n,a[d+7],14,1735328473),n=f(n,o,p,m,a[d+12],20,-1926607734),m=g(m,n,o,p,a[d+5],4,-378558),p=g(p,m,n,o,a[d+8],11,-2022574463),o=g(o,p,m,n,a[d+11],16,1839030562),n=g(n,o,p,m,a[d+14],23,-35309556),m=g(m,n,o,p,a[d+1],4,-1530992060),p=g(p,m,n,o,a[d+4],11,1272893353),o=g(o,p,m,n,a[d+7],16,-155497632),n=g(n,o,p,m,a[d+10],23,-1094730640),m=g(m,n,o,p,a[d+13],4,681279174),p=g(p,m,n,o,a[d],11,-358537222),o=g(o,p,m,n,a[d+3],16,-722521979),n=g(n,o,p,m,a[d+6],23,76029189),m=g(m,n,o,p,a[d+9],4,-640364487),p=g(p,m,n,o,a[d+12],11,-421815835),o=g(o,p,m,n,a[d+15],16,530742520),n=g(n,o,p,m,a[d+2],23,-995338651),m=h(m,n,o,p,a[d],6,-198630844),p=h(p,m,n,o,a[d+7],10,1126891415),o=h(o,p,m,n,a[d+14],15,-1416354905),n=h(n,o,p,m,a[d+5],21,-57434055),m=h(m,n,o,p,a[d+12],6,1700485571),p=h(p,m,n,o,a[d+3],10,-1894986606),o=h(o,p,m,n,a[d+10],15,-1051523),n=h(n,o,p,m,a[d+1],21,-2054922799),m=h(m,n,o,p,a[d+8],6,1873313359),p=h(p,m,n,o,a[d+15],10,-30611744),o=h(o,p,m,n,a[d+6],15,-1560198380),n=h(n,o,p,m,a[d+13],21,1309151649),m=h(m,n,o,p,a[d+4],6,-145523070),p=h(p,m,n,o,a[d+11],10,-1120210379),o=h(o,p,m,n,a[d+2],15,718787259),n=h(n,o,p,m,a[d+9],21,-343485551),m=b(m,i),n=b(n,j),o=b(o,k),p=b(p,l);return[m,n,o,p]}function j(a){var b,c="";for(b=0;b<32*a.length;b+=8)c+=String.fromCharCode(a[b>>5]>>>b%32&255);return c}function k(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c}function l(a){return j(i(k(a),8*a.length))}function m(a,b){var c,d,e=k(a),f=[],g=[];for(f[15]=g[15]=void 0,e.length>16&&(e=i(e,8*a.length)),c=0;16>c;c+=1)f[c]=909522486^e[c],g[c]=1549556828^e[c];return d=i(f.concat(k(b)),512+8*b.length),j(i(g.concat(d),640))}function n(a){var b,c,d="0123456789abcdef",e="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),e+=d.charAt(b>>>4&15)+d.charAt(15&b);return e}function o(a){return unescape(encodeURIComponent(a))}function p(a){return l(o(a))}function q(a){return n(p(a))}function r(a,b){return m(o(a),o(b))}function s(a,b){return n(r(a,b))}function t(a,b,c){return b?c?r(b,a):s(b,a):c?p(a):q(a)}"function"==typeof define&&define.amd?define(function(){return t}):a.md5=t}(this);